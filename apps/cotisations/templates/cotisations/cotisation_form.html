{% extends "cotisations/base.html" %}
{% load i18n %}
{% load static %}
{% load custom_filters %}

{% block breadcrumb %}
{% if form.instance.pk %}
<li class="breadcrumb-item"><a href="{% url 'cotisations:cotisation_liste' %}">{% trans "Liste des cotisations" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'cotisations:cotisation_detail' pk=form.instance.pk %}">{{ form.instance.reference }}</a></li>
<li class="breadcrumb-item active">{% trans "Modifier" %}</li>
{% else %}
<li class="breadcrumb-item"><a href="{% url 'cotisations:cotisation_liste' %}">{% trans "Liste des cotisations" %}</a></li>
<li class="breadcrumb-item active">{% trans "Nouvelle cotisation" %}</li>
{% endif %}
{% endblock %}

{% block page_title %}
{% if form.instance.pk %}
{% trans "Modifier la cotisation" %} {{ form.instance.reference }}
{% else %}
{% trans "Nouvelle cotisation" %}
{% endif %}
{% endblock %}

{% block cotisations_content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <form method="post" id="cotisationForm" novalidate>
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {% trans "Veuillez corriger les erreurs ci-dessous." %}
                    </div>
                    {% endif %}
                    
                    <div class="row g-3">
                        <!-- Première section - Informations de base -->
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">{% trans "Informations de base" %}</h5>
                        </div>
                        
                        <!-- Membre -->
                        <div class="col-md-6">
                            <div class="form-group{% if form.membre.errors %} is-invalid{% endif %}">
                                {{ form.membre.label_tag }}
                                {{ form.membre }}
                                {% if form.membre.help_text %}
                                <small class="form-text text-muted">{{ form.membre.help_text }}</small>
                                {% endif %}
                                {% if form.membre.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.membre.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Type de membre -->
                        <div class="col-md-6">
                            <div class="form-group{% if form.type_membre.errors %} is-invalid{% endif %}">
                                {{ form.type_membre.label_tag }}
                                {{ form.type_membre }}
                                {% if form.type_membre.help_text %}
                                <small class="form-text text-muted">{{ form.type_membre.help_text }}</small>
                                {% endif %}
                                {% if form.type_membre.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.type_membre.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Deuxième section - Montant et barème -->
                        <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2">{% trans "Montant et barème" %}</h5>
                        </div>
                        
                        {% if not form.instance.pk %}
                        <!-- Utiliser barème (seulement pour la création) -->
                        <div class="col-md-12">
                            <div class="form-check mb-3">
                                {{ form.utiliser_bareme }}
                                {{ form.utiliser_bareme.label_tag }}
                                {% if form.utiliser_bareme.help_text %}
                                <small class="form-text text-muted d-block">{{ form.utiliser_bareme.help_text }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Barème -->
                        <div class="col-md-6" id="baremeContainer">
                            <div class="form-group{% if form.bareme.errors %} is-invalid{% endif %}">
                                {{ form.bareme.label_tag }}
                                {{ form.bareme }}
                                {% if form.bareme.help_text %}
                                <small class="form-text text-muted">{{ form.bareme.help_text }}</small>
                                {% endif %}
                                {% if form.bareme.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.bareme.errors }}
                                </div>
                                {% endif %}
                                <!-- Élément pour afficher les alertes concernant le barème -->
                                <div id="alerte-bareme" class="alert alert-danger mt-2" style="display: none;"></div>
                                <!-- Élément pour afficher les informations de périodicité -->
                                <div id="periodicite-info" class="form-text text-info mt-1" style="display: none;"></div>
                            </div>
                        </div>
                        
                        <!-- Montant -->
                        <div class="col-md-6">
                            <div class="form-group{% if form.montant.errors %} is-invalid{% endif %}">
                                {{ form.montant.label_tag }}
                                <div class="input-group">
                                    {{ form.montant }}
                                    <span class="input-group-text">€</span>
                                </div>
                                {% if form.montant.help_text %}
                                <small class="form-text text-muted">{{ form.montant.help_text }}</small>
                                {% endif %}
                                <div id="calcul-prorata-info" class="text-info small mt-2" style="display: none;">
                                    <i class="fas fa-info-circle"></i> <span id="calcul-prorata-texte"></span>
                                </div>
                                {% if form.montant.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.montant.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Calcul au prorata -->
                        {% if not form.instance.pk %}
                        <div class="col-md-12">
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="calculer_prorata" name="calculer_prorata" checked>
                                <label class="form-check-label" for="calculer_prorata">
                                    {% trans "Calculer le montant au prorata de la période" %}
                                </label>
                                <small class="form-text text-muted d-block">
                                    {% trans "Le montant sera ajusté proportionnellement à la durée de la période." %}
                                </small>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Troisième section - Référence -->
                        <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2">{% trans "Référence" %}</h5>
                        </div>
                        
                        <!-- Référence -->
                        <div class="col-md-12" id="referenceContainer">
                            <div class="form-group{% if form.reference.errors %} is-invalid{% endif %}">
                                {{ form.reference.label_tag }}
                                {% if form.instance.pk %}
                                    <div class="form-control-plaintext">{{ form.instance.reference }}</div>
                                    {{ form.reference.as_hidden }}
                                {% else %}
                                    <div class="form-control-plaintext">
                                        <em>{% trans "La référence sera générée automatiquement à la création" %}</em>
                                    </div>
                                    <input type="hidden" name="reference" value="auto_generate">
                                {% endif %}
                                <small class="form-text text-muted">
                                    {% trans "Format: COT-YYYYMM-XXXXX (année, mois, identifiant unique)" %}
                                </small>
                                {% if form.reference.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.reference.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Quatrième section - Dates -->
                        <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2">{% trans "Dates" %}</h5>
                        </div>
                        
                        <!-- Date d'émission -->
                        <div class="col-md-6">
                            <div class="form-group{% if form.date_emission.errors %} is-invalid{% endif %}">
                                {{ form.date_emission.label_tag }}
                                {{ form.date_emission }}
                                {% if form.date_emission.help_text %}
                                <small class="form-text text-muted">{{ form.date_emission.help_text }}</small>
                                {% endif %}
                                {% if form.date_emission.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.date_emission.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Date d'échéance -->
                        <div class="col-md-6">
                            <div class="form-group{% if form.date_echeance.errors %} is-invalid{% endif %}">
                                {{ form.date_echeance.label_tag }}
                                {{ form.date_echeance }}
                                {% if form.date_echeance.help_text %}
                                <small class="form-text text-muted">{{ form.date_echeance.help_text }}</small>
                                {% endif %}
                                {% if form.date_echeance.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.date_echeance.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Période début -->
                        <div class="col-md-6">
                            <div class="form-group{% if form.periode_debut.errors %} is-invalid{% endif %}">
                                {{ form.periode_debut.label_tag }}
                                {{ form.periode_debut }}
                                {% if form.periode_debut.help_text %}
                                <small class="form-text text-muted">{{ form.periode_debut.help_text }}</small>
                                {% endif %}
                                {% if form.periode_debut.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.periode_debut.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Période fin -->
                        <div class="col-md-6">
                            <div class="form-group{% if form.periode_fin.errors %} is-invalid{% endif %}">
                                {{ form.periode_fin.label_tag }}
                                {{ form.periode_fin }}
                                {% if form.periode_fin.help_text %}
                                <small class="form-text text-muted">{{ form.periode_fin.help_text }}</small>
                                {% endif %}
                                {% if form.periode_fin.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.periode_fin.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Cinquième section - Statut et commentaire -->
                        <div class="col-12 mt-4">
                            <h5 class="border-bottom pb-2">{% trans "Informations complémentaires" %}</h5>
                        </div>
                        
                        <!-- Statut -->
                        <div class="col-md-6">
                            <div class="form-group{% if form.statut.errors %} is-invalid{% endif %}">
                                {{ form.statut.label_tag }}
                                {{ form.statut }}
                                {% if form.statut.help_text %}
                                <small class="form-text text-muted">{{ form.statut.help_text }}</small>
                                {% endif %}
                                {% if form.statut.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.statut.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Commentaire -->
                        <div class="col-md-12 mt-3">
                            <div class="form-group{% if form.commentaire.errors %} is-invalid{% endif %}">
                                {{ form.commentaire.label_tag }}
                                {{ form.commentaire }}
                                {% if form.commentaire.help_text %}
                                <small class="form-text text-muted">{{ form.commentaire.help_text }}</small>
                                {% endif %}
                                {% if form.commentaire.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.commentaire.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Boutons -->
                        <div class="col-12 mt-4 d-flex justify-content-between">
                            {% if form.instance.pk %}
                            <a href="{% url 'cotisations:cotisation_detail' pk=form.instance.pk %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> {% trans "Annuler" %}
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> {% trans "Enregistrer les modifications" %}
                            </button>
                            {% else %}
                            <a href="{% url 'cotisations:cotisation_liste' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> {% trans "Annuler" %}
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> {% trans "Créer la cotisation" %}
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<!-- Commentez temporairement ces scripts pour le débogage -->
<!--
<script src="{% static 'js/cotisations/form-validation.js' %}"></script>
<script src="{% static 'js/cotisations/cotisations.js' %}"></script>
<script src="{% static 'js/cotisations/cotisation_forms.js' %}"></script>
-->

<script>
/**
 * Script JavaScript amélioré pour le formulaire de cotisation
 * 
 * Ce script:
 * - Isole complètement son propre code pour éviter les conflits
 * - Utilise une approche défensive pour la sélection et manipulation des éléments DOM
 * - Implémente un système de journalisation avancé pour faciliter le débogage
 * - Gère correctement les événements de cascade entre les sélecteurs
 * - Garantit que seuls les types de membre liés au membre sélectionné sont affichés
 */
 (function() {
    // Configuration globale
    // Remplacer cette section dans votre fichier JavaScript
    const CONFIG = {
        debugMode: true,         // Activer les logs de débogage détaillés
        logColors: {             // Couleurs pour le débogage dans la console
            info: 'color: #007bff',
            success: 'color: #28a745',
            warning: 'color: #ffc107',
            error: 'color: #dc3545',
            event: 'color: #17a2b8',
            api: 'color: #6610f2'
        },
        apiUrls: {
            // Corriger les URLs pour qu'elles correspondent exactement à celles configurées dans urls.py
            // Utilisation des underscores au lieu des tirets
            typesMembre: '/cotisations/api/types-membre-par-membre/',
            baremes: '/cotisations/api/baremes-par-type/',
            calculMontant: '/cotisations/api/calculer_montant/'
        },
        selectors: {
            form: '#cotisationForm',
            membre: '#id_membre',
            typeMembre: '#id_type_membre',
            bareme: '#id_bareme',
            montant: '#id_montant',
            utiliserBareme: '#id_utiliser_bareme',
            calculerProrata: '#calculer_prorata',
            alerteBareme: '#alerte-bareme',
            periodeDebut: '#id_periode_debut',
            periodeFin: '#id_periode_fin',
        }
    };

    // Ajouter cette fonction au début du script, après la déclaration de CONFIG
// Elle va tester toutes les URLs avant même d'initialiser le formulaire

    function diagnoseApiUrls() {
        console.log('%c=== DIAGNOSTIC DES URLS API ===', 'color: #ff5722; font-weight: bold; font-size: 14px;');
        
        // Liste des variantes d'URL à tester
        const urlVariants = {
            'types_membre': [
                '/cotisations/api/types_membre_par_membre/',
                '/cotisations/api/types-membre-par-membre/',
                '/api/cotisations/types_membre_par_membre/',
                '/api/cotisations/types-membre-par-membre/',
                '/cotisations/api_types_membre_par_membre/',
            ],
            'baremes': [
                '/cotisations/api/baremes_par_type/',
                '/cotisations/api/baremes-par-type/',
                '/api/cotisations/baremes_par_type/',
                '/api/cotisations/baremes-par-type/',
                '/cotisations/api_baremes_par_type/',
            ]
        };
        
        // Extraire un CSRF token pour les requêtes
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
        
        // Créer un petit wrapper pour fetch avec timeout
        function testUrl(url, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout
            
            const defaultOptions = { 
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin',
                signal: controller.signal
            };
            
            const fetchOptions = {...defaultOptions, ...options};
            
            return fetch(url, fetchOptions)
                .then(response => {
                    clearTimeout(timeoutId);
                    return {
                        url,
                        status: response.status,
                        ok: response.ok,
                        headers: Array.from(response.headers.entries())
                    };
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    return {
                        url,
                        error: error.name === 'AbortError' ? 'Timeout' : error.message,
                        ok: false
                    };
                });
        }
        
        // Fonction pour afficher les résultats du test
        function showResults(results) {
            console.log('%c=== RÉSULTATS DU DIAGNOSTIC ===', 'color: #2196f3; font-weight: bold;');
            
            // Organiser par type d'endpoint
            const byEndpoint = {};
            
            results.forEach(result => {
                const urlParts = result.url.split('/').filter(Boolean);
                const endpoint = urlParts[urlParts.length - 1];
                
                if (!byEndpoint[endpoint]) byEndpoint[endpoint] = [];
                byEndpoint[endpoint].push(result);
            });
            
            // Afficher les résultats par endpoint
            Object.entries(byEndpoint).forEach(([endpoint, results]) => {
                console.group(`Endpoint: ${endpoint}`);
                
                // Trier par statut (fonctionnel en premier)
                results.sort((a, b) => {
                    if (a.ok && !b.ok) return -1;
                    if (!a.ok && b.ok) return 1;
                    return 0;
                });
                
                results.forEach(result => {
                    if (result.ok) {
                        console.log(
                            `%c✓ ${result.url} - Status: ${result.status}`,
                            'color: #4caf50; font-weight: bold;'
                        );
                    } else if (result.error) {
                        console.log(
                            `%c✗ ${result.url} - Erreur: ${result.error}`,
                            'color: #f44336;'
                        );
                    } else {
                        console.log(
                            `%c✗ ${result.url} - Status: ${result.status}`,
                            'color: #ff9800;'
                        );
                    }
                });
                
                // Suggestion d'URL à utiliser
                const workingUrl = results.find(r => r.ok);
                if (workingUrl) {
                    console.log(
                        `%c→ URL recommandée: ${workingUrl.url}`,
                        'color: #2196f3; font-weight: bold;'
                    );
                } else {
                    console.log(
                        '%c→ Aucune URL fonctionnelle trouvée pour cet endpoint',
                        'color: #f44336; font-weight: bold;'
                    );
                }
                
                console.groupEnd();
            });
            
            // Recommandations finales
            console.log('%c=== RECOMMANDATIONS ===', 'color: #673ab7; font-weight: bold;');
            
            const anyWorking = results.some(r => r.ok);
            if (anyWorking) {
                console.log(
                    '%c→ Certaines URLs fonctionnent. Veuillez mettre à jour votre CONFIG.apiUrls avec les URLs recommandées ci-dessus.',
                    'color: #4caf50;'
                );
            } else {
                console.log(
                    '%c→ Aucune URL testée ne fonctionne. Veuillez vérifier les points suivants:',
                    'color: #f44336;'
                );
                console.log('  1. Les URLs sont correctement configurées dans urls.py');
                console.log('  2. Le serveur Django est en cours d\'exécution');
                console.log('  3. Vous avez les permissions nécessaires (session active)');
                console.log('  4. Il n\'y a pas d\'erreurs côté serveur (vérifiez les logs Django)');
            }
        }

        // Exécuter les tests
        console.log('Diagnostic en cours, veuillez patienter...');
        
        // Créer une liste plate de toutes les URLs à tester
        const allUrls = [];
        Object.values(urlVariants).forEach(variants => {
            variants.forEach(url => allUrls.push(url));
        });
        
        // Tester toutes les URLs et collecter les résultats
        Promise.all(allUrls.map(url => testUrl(url)))
            .then(results => {
                showResults(results);
                
                // Mise à jour automatique de CONFIG si possible
                const workingUrls = {};
                
                Object.entries(urlVariants).forEach(([key, variants]) => {
                    const working = results.find(r => 
                        variants.includes(r.url) && r.ok
                    );
                    
                    if (working) {
                        workingUrls[key] = working.url;
                    }
                });
                
                if (Object.keys(workingUrls).length > 0) {
                    console.log('%c=== MISE À JOUR AUTOMATIQUE ===', 'color: #009688; font-weight: bold;');
                    console.log('URLs fonctionnelles détectées:');
                    
                    // Mettre à jour CONFIG si possible
                    if (workingUrls.types_membre) {
                        console.log(`typesMembre: "${workingUrls.types_membre}"`);
                        CONFIG.apiUrls.typesMembre = workingUrls.types_membre;
                    }
                    
                    if (workingUrls.baremes) {
                        console.log(`baremes: "${workingUrls.baremes}"`);
                        CONFIG.apiUrls.baremes = workingUrls.baremes;
                    }
                    
                    console.log('%cCONFIG a été mis à jour automatiquement avec les URLs fonctionnelles!', 'color: #009688; font-weight: bold;');
                }
            });
    }

    // Pour appeler l'outil de diagnostic avant l'initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Exécuter le diagnostic des URLs
        diagnoseApiUrls();
        
        // Continue avec l'initialisation normale
        console.log('%c=== Formulaire de Cotisation - Initialisation ===', 'color: #28a745; font-weight: bold;');
        FormManager.init();
    });

    // Système de journalisation amélioré
    const Logger = {
        log(type, message, data = null) {
            if (!CONFIG.debugMode) return;

            const style = CONFIG.logColors[type] || '';
            const timestamp = new Date().toISOString().slice(11, 19);
            
            if (data) {
                console.groupCollapsed(`%c[${timestamp}] ${message}`, style);
                console.log('Données:', data);
                console.groupEnd();
            } else {
                console.log(`%c[${timestamp}] ${message}`, style);
            }
        },
        info(message, data) { this.log('info', message, data); },
        success(message, data) { this.log('success', message, data); },
        warning(message, data) { this.log('warning', message, data); },
        error(message, data) { this.log('error', message, data); },
        event(message, data) { this.log('event', message, data); },
        api(message, data) { this.log('api', message, data); }
    };

    // Gestionnaire principal du formulaire
    const FormManager = {
        elements: {},

        // Initialisation
        init() {
            Logger.info('Initialisation du gestionnaire de formulaire');
            
            this.resetDomCache();
            this.setupEventListeners();
            this.initializeForm();
            
            Logger.success('Formulaire initialisé avec succès');
        },

        // Réinitialise le cache DOM et garantit des références propres
        resetDomCache() {
            Logger.info('Réinitialisation du cache DOM');
            
            // Remplacer tous les éléments importants pour supprimer les gestionnaires existants
            this.replaceElements();
            
            // Cache des éléments DOM après remplacement
            this.elements = {};
            
            // Sélection sécurisée des éléments
            for (const [key, selector] of Object.entries(CONFIG.selectors)) {
                this.elements[key] = document.querySelector(selector);
                if (!this.elements[key]) {
                    Logger.warning(`Élément non trouvé: ${key} (${selector})`);
                }
            }
            
            Logger.info('Éléments DOM chargés', this.elements);
        },
        
        // Remplace les éléments principaux par des clones pour supprimer les gestionnaires d'événements
        replaceElements() {
            Logger.info('Remplacement des éléments DOM pour nettoyage');
            
            const elementsToClean = [
                CONFIG.selectors.membre, 
                CONFIG.selectors.typeMembre, 
                CONFIG.selectors.bareme
            ];
            
            elementsToClean.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    const clone = element.cloneNode(true);
                    element.parentNode.replaceChild(clone, element);
                    Logger.info(`Élément remplacé: ${selector}`);
                }
            });
        },

        // Configuration des écouteurs d'événements
        setupEventListeners() {
            Logger.info('Configuration des écouteurs d\'événements');
            
            // 1. Changement de membre
            if (this.elements.membre) {
                this.elements.membre.addEventListener('change', this.handleMembreChange.bind(this));
                Logger.info('Écouteur ajouté: changement de membre');
            }
            
            // 2. Changement de type de membre
            if (this.elements.typeMembre) {
                this.elements.typeMembre.addEventListener('change', this.handleTypeMembreChange.bind(this));
                Logger.info('Écouteur ajouté: changement de type de membre');
            }
            
            // 3. Changement de barème
            if (this.elements.bareme) {
                this.elements.bareme.addEventListener('change', this.handleBaremeChange.bind(this));
                Logger.info('Écouteur ajouté: changement de barème');
            }
            
            // 4. Option "utiliser barème"
            if (this.elements.utiliserBareme) {
                this.elements.utiliserBareme.addEventListener('change', this.handleUtiliserBaremeChange.bind(this));
                Logger.info('Écouteur ajouté: utiliser barème');
            }
        },

        // Initialisation du formulaire au chargement
        initializeForm() {
            Logger.info('Initialisation de l\'état du formulaire');
            
            // Initialiser l'état lecture seule du montant
            if (this.elements.utiliserBareme) {
                this.toggleMontantReadOnly(this.elements.utiliserBareme.checked);
            }
            
            // Si un membre est déjà sélectionné, charger ses types
            if (this.elements.membre && this.elements.membre.value) {
                Logger.info(`Membre déjà sélectionné: ${this.elements.membre.value}`);
                this.loadTypesMembre(this.elements.membre.value);
            } else {
                // Désactiver le sélecteur de type si aucun membre sélectionné
                this.resetTypeMembreOptions();
                this.resetBaremeOptions();
            }
            
            // Vérifier s'il y a des erreurs de formulaire et les traiter
            this.checkForFormErrors();
        },
        
        // Vérifie la présence d'erreurs de validation Django et les traite
        checkForFormErrors() {
            const formErrors = document.querySelectorAll('.invalid-feedback');
            if (formErrors.length > 0) {
                Logger.warning(`${formErrors.length} erreurs de formulaire détectées`);
                // Ici on pourrait ajouter du code pour traiter ces erreurs
            }
        },

        // Gestionnaires d'événements
        
        // Gestion du changement de membre
        handleMembreChange(event) {
            const membreId = event.target.value;
            Logger.event(`Membre changé: ${membreId}`);
            
            // Réinitialiser les éléments en cascade
            this.resetTypeMembreOptions();
            this.resetBaremeOptions();
            this.resetMontant();
            
            // Charger les types de membre si un membre est sélectionné
            if (membreId) {
                this.loadTypesMembre(membreId);
            }
        },
        
        // Gestion du changement de type de membre
        handleTypeMembreChange(event) {
            const typeMembreId = event.target.value;
            Logger.event(`Type de membre changé: ${typeMembreId}`);
            
            // Réinitialiser les éléments suivants
            this.resetBaremeOptions();
            this.resetMontant();
            
            // Charger les barèmes si un type est sélectionné
            if (typeMembreId) {
                this.loadBaremes(typeMembreId);
            }
        },
        
        // Gestion du changement de barème
        handleBaremeChange(event) {
            const baremeId = event.target.value;
            Logger.event(`Barème changé: ${baremeId}`);
            
            // Calculer le montant si un barème est sélectionné
            if (baremeId) {
                this.calculateMontant(baremeId);
            } else {
                this.resetMontant();
            }
        },
        
        // Gestion du changement d'option "utiliser barème"
        handleUtiliserBaremeChange(event) {
            const useBareme = event.target.checked;
            Logger.event(`Utiliser barème: ${useBareme}`);
            
            this.toggleMontantReadOnly(useBareme);
        },

        // Fonctions de chargement des données
        
        // Charge les types de membre pour un membre spécifique
        loadTypesMembre(membreId) {
            Logger.info(`Chargement des types pour le membre ${membreId}`);
            
            // Désactiver et afficher "Chargement..." dans le sélecteur
            if (this.elements.typeMembre) {
                this.elements.typeMembre.disabled = true;
                this.elements.typeMembre.innerHTML = '<option value="">Chargement...</option>';
            }
            
            // Construire l'URL avec l'ID du membre
            const url = `${CONFIG.apiUrls.typesMembre}?membre_id=${encodeURIComponent(membreId)}`;
            Logger.api(`Appel API: ${url}`);
            
            // Effectuer la requête
            this.fetchData(url)
                .then(data => {
                    Logger.api('Réponse API Types Membre', data);
                    this.updateTypeMembreOptions(data);
                })
                .catch(error => {
                    Logger.error('Erreur lors du chargement des types de membre', error);
                    this.showError("Erreur lors du chargement des types de membre.");
                    this.resetTypeMembreOptions(true); // true = erreur
                });
        },
        
        // Charge les barèmes pour un type de membre spécifique
        loadBaremes(typeMembreId) {
            Logger.info(`Chargement des barèmes pour le type ${typeMembreId}`);
            
            // Désactiver et afficher "Chargement..." dans le sélecteur
            if (this.elements.bareme) {
                this.elements.bareme.disabled = true;
                this.elements.bareme.innerHTML = '<option value="">Chargement...</option>';
            }
            
            // Construire l'URL avec l'ID du type de membre
            const url = `${CONFIG.apiUrls.baremes}?type_membre=${encodeURIComponent(typeMembreId)}`;
            Logger.api(`Appel API: ${url}`);
            
            // Effectuer la requête
            this.fetchData(url)
                .then(data => {
                    Logger.api('Réponse API Barèmes', data);
                    this.updateBaremeOptions(data);
                })
                .catch(error => {
                    Logger.error('Erreur lors du chargement des barèmes', error);
                    this.showError("Erreur lors du chargement des barèmes.");
                    this.resetBaremeOptions(true); // true = erreur
                });
        },
        
        // Calcule le montant à partir d'un barème
        calculateMontant(baremeId) {
            Logger.info(`Calcul du montant pour le barème ${baremeId}`);
            
            // Vérifier si on utilise le barème
            if (this.elements.utiliserBareme && !this.elements.utiliserBareme.checked) {
                Logger.info('Calcul ignoré: utilisation du barème désactivée');
                return;
            }
            
            // Essayer d'abord de récupérer le montant depuis l'option sélectionnée
            if (this.elements.bareme && this.elements.bareme.selectedIndex > 0) {
                const selectedOption = this.elements.bareme.options[this.elements.bareme.selectedIndex];
                if (selectedOption && selectedOption.dataset && selectedOption.dataset.montant) {
                    const montant = parseFloat(selectedOption.dataset.montant);
                    Logger.info(`Montant trouvé dans l'option: ${montant}`);
                    
                    if (this.elements.montant) {
                        this.elements.montant.value = montant.toFixed(2);
                    }
                    return;
                }
            }
            
            // Si non disponible dans l'option, faire une requête API
            const url = `${CONFIG.apiUrls.calculMontant}?bareme_id=${encodeURIComponent(baremeId)}`;
            Logger.api(`Appel API: ${url}`);
            
            // Effectuer la requête
            this.fetchData(url)
                .then(data => {
                    Logger.api('Réponse API Calcul Montant', data);
                    
                    if (data.success && this.elements.montant) {
                        const montant = parseFloat(data.montant);
                        this.elements.montant.value = montant.toFixed(2);
                        Logger.success(`Montant calculé: ${montant}`);
                    } else {
                        this.showError("Erreur lors du calcul du montant.");
                    }
                })
                .catch(error => {
                    Logger.error('Erreur lors du calcul du montant', error);
                    this.showError("Erreur lors du calcul du montant.");
                });
        },

        // Méthodes pour mettre à jour l'interface
        
        // Met à jour les options du sélecteur de type de membre
        updateTypeMembreOptions(data) {
            Logger.info('Mise à jour des options de type de membre');
            
            // Vérifier la disponibilité du sélecteur
            if (!this.elements.typeMembre) {
                Logger.error('Sélecteur de type de membre non disponible');
                return;
            }
            
            // Vider et réactiver le sélecteur
            this.elements.typeMembre.innerHTML = '';
            this.elements.typeMembre.disabled = false;
            
            // Option par défaut
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Sélectionnez un type de membre';
            this.elements.typeMembre.appendChild(defaultOption);
            
            // Ajouter les options si des données sont disponibles
            if (data.success && data.types_membre && data.types_membre.length > 0) {
                Logger.info(`Types de membres disponibles: ${data.types_membre.length}`);
                
                // Ajouter chaque type de membre comme option
                data.types_membre.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.libelle;
                    this.elements.typeMembre.appendChild(option);
                    Logger.info(`Type ajouté: ${type.id} - ${type.libelle}`);
                });
                
                // Sélection automatique si un seul type
                if (data.single_type && data.types_membre.length === 1) {
                    try {
                        // Sélectionner directement par la valeur
                        this.elements.typeMembre.value = data.types_membre[0].id;
                        Logger.success(`Type sélectionné automatiquement: ${data.types_membre[0].id}`);
                        
                        // Vérifier si la sélection a réussi
                        if (this.elements.typeMembre.value != data.types_membre[0].id) {
                            // Méthode alternative: sélectionner par index
                            Logger.warning('Échec de la sélection par value, tentative par index');
                            this.elements.typeMembre.selectedIndex = 1; // L'index 0 est l'option vide
                        }
                        
                        // Déclencher l'événement change
                        this.triggerChangeEvent(this.elements.typeMembre);
                    } catch (err) {
                        Logger.error('Erreur lors de la sélection automatique', err);
                    }
                }
            } else {
                Logger.warning('Aucun type de membre disponible');
                
                // Option indiquant qu'aucun type n'est disponible
                const emptyOption = document.createElement('option');
                emptyOption.disabled = true;
                emptyOption.textContent = 'Aucun type de membre disponible';
                this.elements.typeMembre.appendChild(emptyOption);
            }
        },
        
        // Met à jour les options du sélecteur de barème
        updateBaremeOptions(data) {
            Logger.info('Mise à jour des options de barème');
            
            // Vérifier la disponibilité du sélecteur
            if (!this.elements.bareme) {
                Logger.error('Sélecteur de barème non disponible');
                return;
            }
            
            // Vider et réactiver le sélecteur
            this.elements.bareme.innerHTML = '';
            this.elements.bareme.disabled = false;
            
            // Option par défaut
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Sélectionnez un barème';
            this.elements.bareme.appendChild(defaultOption);
            
            // Ajouter les options si des données sont disponibles
            if (data.success && data.baremes && data.baremes.length > 0) {
                Logger.info(`Barèmes disponibles: ${data.baremes.length}`);
                
                // Stocker l'ID du barème actif s'il existe
                let baremeActifId = null;
                
                // Ajouter chaque barème comme option
                data.baremes.forEach(bareme => {
                    const option = document.createElement('option');
                    option.value = bareme.id;
                    
                    // Construire le libellé avec les informations pertinentes
                    let label = `${bareme.montant} € (${bareme.periodicite_display})`;
                    if (bareme.est_actif) {
                        label += ' - Actif';
                        baremeActifId = bareme.id;
                    } else if (bareme.est_futur) {
                        label += ' - Futur';
                    }
                    
                    option.textContent = label;
                    
                    // Stocker les données pour utilisation ultérieure
                    option.dataset.montant = bareme.montant;
                    option.dataset.periodicite = bareme.periodicite;
                    
                    this.elements.bareme.appendChild(option);
                    Logger.info(`Barème ajouté: ${bareme.id} - ${label}`);
                });
                
                // Sélection automatique du barème actif ou du premier si un seul
                if (baremeActifId) {
                    // Sélectionner le barème actif
                    this.elements.bareme.value = baremeActifId;
                    Logger.success(`Barème actif sélectionné: ${baremeActifId}`);
                } else if (data.baremes.length === 1) {
                    // S'il n'y a qu'un seul barème, le sélectionner
                    this.elements.bareme.value = data.baremes[0].id;
                    Logger.success(`Barème unique sélectionné: ${data.baremes[0].id}`);
                }
                
                // Déclencher l'événement change si une sélection a été faite
                if (this.elements.bareme.value) {
                    this.triggerChangeEvent(this.elements.bareme);
                }
            } else {
                Logger.warning('Aucun barème disponible');
                
                // Option indiquant qu'aucun barème n'est disponible
                const emptyOption = document.createElement('option');
                emptyOption.disabled = true;
                emptyOption.textContent = 'Aucun barème disponible';
                this.elements.bareme.appendChild(emptyOption);
            }
        },
        
        // Active/désactive le mode lecture seule du montant
        toggleMontantReadOnly(readOnly) {
            Logger.info(`Mode lecture seule du montant: ${readOnly}`);
            
            if (!this.elements.montant) return;
            
            this.elements.montant.readOnly = readOnly;
            
            if (readOnly) {
                // Ajouter une classe visuelle
                this.elements.montant.classList.add('bg-light');
                
                // Recalculer le montant si un barème est sélectionné
                if (this.elements.bareme && this.elements.bareme.value) {
                    this.calculateMontant(this.elements.bareme.value);
                }
            } else {
                // Retirer la classe visuelle
                this.elements.montant.classList.remove('bg-light');
            }
        },
        
        // Affiche un message d'erreur
        showError(message, duration = 5000) {
            Logger.error(`Affichage d'erreur: ${message}`);
            
            // Afficher dans la console en mode développement
            if (CONFIG.debugMode) {
                console.error(message);
            }
            
            // Afficher dans l'élément d'alerte si disponible
            if (this.elements.alerteBareme) {
                // Échapper le HTML pour éviter les injections XSS
                this.elements.alerteBareme.textContent = message;
                this.elements.alerteBareme.style.display = 'block';
                
                // Masquer après un délai
                setTimeout(() => {
                    this.elements.alerteBareme.style.display = 'none';
                }, duration);
            }
        },

        // Méthodes de réinitialisation
        
        // Réinitialise les options du sélecteur de type de membre
        resetTypeMembreOptions(isError = false) {
            Logger.info('Réinitialisation des options de type de membre');
            
            if (!this.elements.typeMembre) return;
            
            // Vider le sélecteur
            this.elements.typeMembre.innerHTML = '';
            
            // Ajouter une option par défaut
            const option = document.createElement('option');
            option.value = '';
            
            if (isError) {
                option.textContent = 'Erreur - Veuillez réessayer';
            } else {
                option.textContent = 'Sélectionnez d\'abord un membre';
            }
            
            this.elements.typeMembre.appendChild(option);
            this.elements.typeMembre.disabled = true;
        },
        
        // Réinitialise les options du sélecteur de barème
        resetBaremeOptions(isError = false) {
            Logger.info('Réinitialisation des options de barème');
            
            if (!this.elements.bareme) return;
            
            // Vider le sélecteur
            this.elements.bareme.innerHTML = '';
            
            // Ajouter une option par défaut
            const option = document.createElement('option');
            option.value = '';
            
            if (isError) {
                option.textContent = 'Erreur - Veuillez réessayer';
            } else {
                option.textContent = 'Sélectionnez d\'abord un type de membre';
            }
            
            this.elements.bareme.appendChild(option);
            this.elements.bareme.disabled = true;
        },
        
        // Réinitialise le champ montant
        resetMontant() {
            Logger.info('Réinitialisation du montant');
            
            if (!this.elements.montant) return;
            
            // Ne réinitialiser que si le barème est utilisé
            if (this.elements.utiliserBareme && this.elements.utiliserBareme.checked) {
                this.elements.montant.value = '';
            }
        },

        // Méthodes utilitaires
        
        // Effectue une requête AJAX standard
        fetchData(url) {
            return fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            });
        },
        
        // Déclenche un événement change de manière compatible avec tous les navigateurs
        triggerChangeEvent(element) {
            if (!element) return;
            
            try {
                // Méthode moderne
                const event = new Event('change', { bubbles: true });
                element.dispatchEvent(event);
            } catch (e) {
                // Méthode compatible avec les anciens navigateurs
                const event = document.createEvent('HTMLEvents');
                event.initEvent('change', true, false);
                element.dispatchEvent(event);
            }
            
            Logger.info(`Événement change déclenché sur ${element.id || 'élément'}`);
        }
    };

    // Lancement de l'initialisation au chargement du document
    document.addEventListener('DOMContentLoaded', function() {
        // Message de démarrage
        console.log('%c=== Formulaire de Cotisation - Initialisation ===', 'color: #28a745; font-weight: bold;');
        
        // Initialiser le gestionnaire de formulaire
        FormManager.init();
    });
})();
</script>
{% endblock %}