<!-- Version corrigée - cotisation_detail.html -->
{% extends "cotisations/base.html" %}
{% load i18n %}
{% load static %}
{% load cotisations_extras %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'cotisations:cotisation_liste' %}">{% trans "Liste des cotisations" %}</a></li>
<li class="breadcrumb-item active">{{ cotisation.reference|escape }}</li>
{% endblock %}

{% block page_title %}
{% trans "Détails de la cotisation" %} {{ cotisation.reference|escape }}
{% endblock %}

{% block actions %}
<div class="btn-group">
    <a href="{% url 'cotisations:cotisation_modifier' pk=cotisation.pk %}" class="btn btn-outline-secondary">
        <i class="fas fa-edit" aria-hidden="true"></i> {% trans "Modifier" %}
    </a>
    <a href="{% url 'cotisations:paiement_creer' cotisation_id=cotisation.pk %}" class="btn btn-success">
        <i class="fas fa-money-bill-wave" aria-hidden="true"></i> {% trans "Ajouter un paiement" %}
    </a>
    <a href="{% url 'cotisations:rappel_creer' cotisation_id=cotisation.pk %}" class="btn btn-warning">
        <i class="fas fa-bell" aria-hidden="true"></i> {% trans "Créer un rappel" %}
    </a>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#paiementModal">
        <i class="fas fa-plus-circle" aria-hidden="true"></i> {% trans "Paiement rapide" %}
    </button>
</div>
{% endblock %}

{% block cotisations_content %}
<div id="cotisationDetail" data-cotisation-id="{{ cotisation.pk }}">
    <div class="row">
        <!-- Informations principales de la cotisation -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">{% trans "Informations générales" %}</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">{% trans "Référence" %}</dt>
                        <dd class="col-sm-7" id="cotisation-reference">{{ cotisation.reference|escape }}</dd>
                        
                        <dt class="col-sm-5">{% trans "Membre" %}</dt>
                        <dd class="col-sm-7">
                            <a href="{% url 'membres:membre_detail' pk=cotisation.membre.pk %}">
                                <span id="membre-prenom">{{ cotisation.membre.prenom|escape }}</span> <span id="membre-nom">{{ cotisation.membre.nom|escape }}</span>
                            </a>
                            <br><small class="text-muted" id="membre-email">{{ cotisation.membre.email|escape }}</small>
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Date d'émission" %}</dt>
                        <dd class="col-sm-7">{{ cotisation.date_emission|date:"d/m/Y" }}</dd>
                        
                        <dt class="col-sm-5">{% trans "Date d'échéance" %}</dt>
                        <dd class="col-sm-7" id="cotisation-echeance">
                            <span class="{% if cotisation.est_en_retard %}text-danger{% endif %}">
                                {{ cotisation.date_echeance|date:"d/m/Y" }}
                                {% if cotisation.est_en_retard %}
                                <br><small class="text-danger">{{ cotisation.jours_retard }} {% trans "jours de retard" %}</small>
                                {% endif %}
                            </span>
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Période couverte" %}</dt>
                        <dd class="col-sm-7">
                            {{ cotisation.periode_debut|date:"d/m/Y" }}
                            {% if cotisation.periode_fin %}
                            - {{ cotisation.periode_fin|date:"d/m/Y" }}
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        
        <!-- Informations financières -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">{% trans "Informations financières" %}</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">{% trans "Type de membre" %}</dt>
                        <dd class="col-sm-7">{{ cotisation.type_membre.libelle|default:"-"|escape }}</dd>
                        
                        <dt class="col-sm-5">{% trans "Barème" %}</dt>
                        <dd class="col-sm-7">
                            {% if cotisation.bareme %}
                            {{ cotisation.bareme.montant|floatformat:2 }} € ({{ cotisation.bareme.get_periodicite_display }})
                            {% else %}
                            <span class="text-muted">{% trans "Non spécifié" %}</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Montant total" %}</dt>
                        <dd class="col-sm-7" id="montant-total" data-value="{{ cotisation.montant }}">{{ cotisation.montant|floatformat:2 }} €</dd>
                        
                        <dt class="col-sm-5">{% trans "Montant payé" %}</dt>
                        <dd class="col-sm-7">
                            <span id="montant-paye" data-value="{{ cotisation.montant|sub:cotisation.montant_restant }}">{{ cotisation.montant|sub:cotisation.montant_restant|floatformat:2 }} €</span>
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Montant restant" %}</dt>
                        <dd class="col-sm-7">
                            <span id="montant-restant" 
                                  class="fw-bold {% if cotisation.montant_restant > 0 %}text-danger{% else %}text-success{% endif %}"
                                  data-value="{{ cotisation.montant_restant }}">
                                {{ cotisation.montant_restant|floatformat:2 }} €
                            </span>
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Statut" %}</dt>
                        <dd class="col-sm-7">
                            <span id="statut-paiement" class="badge 
                                {% if cotisation.statut_paiement == 'non_payee' %}bg-danger
                                {% elif cotisation.statut_paiement == 'partiellement_payee' %}bg-warning
                                {% else %}bg-success{% endif %}"
                                data-statut="{{ cotisation.statut_paiement }}">
                                {{ cotisation.get_statut_paiement_display }}
                            </span>
                        </dd>
                    </dl>
                    
                    <!-- Barre de progression du paiement -->
                    <div class="mt-4">
                        <h6 class="mb-2">{% trans "Progression du paiement" %}</h6>
                        <div class="progress" style="height: 20px;">
                            {% with pourcentage=cotisation.pourcentage_paiement|default:0 %}
                            <div id="progression-paiement" class="progress-bar 
                                {% if cotisation.statut_paiement == 'non_payee' %}bg-danger
                                {% elif cotisation.statut_paiement == 'partiellement_payee' %}bg-warning
                                {% else %}bg-success{% endif %}" 
                                 role="progressbar" 
                                 data-montant-total="{{ cotisation.montant }}"
                                 style="width: {{ pourcentage }}%;" 
                                 aria-valuenow="{{ pourcentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ pourcentage }}%
                            </div>
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Liste des paiements -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="card-title mb-0">{% trans "Paiements" %}</h5>
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#paiementModal">
                        <i class="fas fa-plus" aria-hidden="true"></i> {% trans "Ajouter un paiement" %}
                    </button>
                </div>
                <div class="card-body">
                    {% if paiements %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="paiements-list">
                            <thead>
                                <tr>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Montant" %}</th>
                                    <th>{% trans "Mode" %}</th>
                                    <th>{% trans "Type" %}</th>
                                    <th>{% trans "Référence" %}</th>
                                    <th class="text-center">{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for paiement in paiements %}
                                <tr id="paiement-{{ paiement.id }}">
                                    <td>{{ paiement.date_paiement|date:"d/m/Y H:i" }}</td>
                                    <td>{{ paiement.montant|floatformat:2 }} €</td>
                                    <td>{{ paiement.mode_paiement|default:"-"|escape }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if paiement.type_transaction == 'paiement' %}bg-success
                                            {% elif paiement.type_transaction == 'remboursement' %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ paiement.get_type_transaction_display }}
                                        </span>
                                    </td>
                                    <td>{{ paiement.reference_paiement|default:"-"|escape }}</td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <a href="{% url 'cotisations:paiement_detail' pk=paiement.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye" aria-hidden="true"></i>
                                                <span class="visually-hidden">{% trans "Voir" %}</span>
                                            </a>
                                            <a href="{% url 'cotisations:paiement_modifier' pk=paiement.pk %}" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-edit" aria-hidden="true"></i>
                                                <span class="visually-hidden">{% trans "Modifier" %}</span>
                                            </a>
                                            <a href="{% url 'cotisations:paiement_supprimer' pk=paiement.pk %}" class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-trash" aria-hidden="true"></i>
                                                <span class="visually-hidden">{% trans "Supprimer" %}</span>
                                            </a>
                                            {% if paiement.type_transaction == 'paiement' %}
                                            <a href="{% url 'cotisations:api_generer_recu' paiement_id=paiement.pk %}" class="btn btn-sm btn-outline-info" aria-label="{% trans 'Générer un reçu' %}">
                                                <i class="fas fa-file-invoice" aria-hidden="true"></i>
                                                <span class="visually-hidden">{% trans "Générer un reçu" %}</span>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info" id="no-paiements-message">
                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        {% trans "Aucun paiement n'a été enregistré pour cette cotisation." %}
                        <button type="button" class="btn btn-sm btn-outline-primary ms-3" data-bs-toggle="modal" data-bs-target="#paiementModal">
                            {% trans "Ajouter un paiement" %}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Liste des rappels -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="card-title mb-0">{% trans "Rappels" %}</h5>
                    <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#rappelModal" id="rappelModalTrigger">
                        <i class="fas fa-plus" aria-hidden="true"></i> {% trans "Créer un rappel" %}
                    </button>
                </div>
                <div class="card-body">
                    {% if rappels %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="rappels-list">
                            <thead>
                                <tr>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Type" %}</th>
                                    <th>{% trans "Niveau" %}</th>
                                    <th>{% trans "État" %}</th>
                                    <th>{% trans "Contenu" %}</th>
                                    <th class="text-center">{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rappel in rappels %}
                                <tr id="rappel-{{ rappel.id }}">
                                    <td>{{ rappel.date_envoi|date:"d/m/Y H:i" }}</td>
                                    <td>{{ rappel.get_type_rappel_display }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if rappel.niveau == 1 %}bg-info
                                            {% elif rappel.niveau == 2 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ rappel.niveau }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if rappel.etat == 'planifie' %}bg-secondary
                                            {% elif rappel.etat == 'envoye' %}bg-success
                                            {% elif rappel.etat == 'echoue' %}bg-danger
                                            {% else %}bg-info{% endif %}">
                                            {{ rappel.get_etat_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-link voir-contenu"
                                                data-contenu="{{ rappel.contenu|escape }}"
                                                data-bs-toggle="modal" data-bs-target="#contenuModal">
                                            {% trans "Voir le contenu" %}
                                        </button>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            {% if rappel.etat == 'planifie' %}
                                            <a href="{% url 'cotisations:envoyer_rappel' rappel_id=rappel.pk %}" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-paper-plane" aria-hidden="true"></i> {% trans "Envoyer" %}
                                            </a>
                                            {% endif %}
                                            <a href="{% url 'cotisations:rappel_detail' pk=rappel.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye" aria-hidden="true"></i>
                                                <span class="visually-hidden">{% trans "Voir" %}</span>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info" id="no-rappels-message">
                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        {% trans "Aucun rappel n'a été créé pour cette cotisation." %}
                        <button type="button" class="btn btn-sm btn-outline-primary ms-3" data-bs-toggle="modal" data-bs-target="#rappelModal">
                            {% trans "Créer un rappel" %}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Historique des modifications -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">{% trans "Historique" %}</h5>
                </div>
                <div class="card-body">
                    {% if historique %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Action" %}</th>
                                    <th>{% trans "Utilisateur" %}</th>
                                    <th>{% trans "Détails" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in historique %}
                                <tr>
                                    <td>{{ entry.date_action|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if entry.action == 'creation' %}bg-success
                                            {% elif entry.action == 'modification' %}bg-info
                                            {% elif entry.action == 'suppression' %}bg-danger
                                            {% elif entry.action == 'paiement_ajoute' %}bg-primary
                                            {% elif entry.action == 'paiement_supprime' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ entry.get_action_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if entry.utilisateur %}
                                        {{ entry.utilisateur.username|escape }}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-link voir-details"
                                                data-details="{{ entry.details|escape }}"
                                                data-bs-toggle="modal" data-bs-target="#detailsModal">
                                            {% trans "Voir les détails" %}
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        {% trans "Aucun historique disponible pour cette cotisation." %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour l'ajout rapide de paiement -->
<div class="modal fade" id="paiementModal" tabindex="-1" aria-labelledby="paiementModalLabel" aria-modal="true" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paiementModalLabel">{% trans "Ajouter un paiement" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Fermer' %}"></button>
            </div>
            <div class="modal-body">
                <form id="paiementAjaxForm" data-cotisation-id="{{ cotisation.pk }}" novalidate>
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="formMontant" class="form-label">{% trans "Montant" %}</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="formMontant" name="montant" min="0.01" step="0.01" required>
                            <span class="input-group-text">€</span>
                        </div>
                        <div id="montantHelp" class="form-text">
                            {% trans "Montant maximum autorisé" %}: {{ cotisation.montant_restant|floatformat:2 }} €
                        </div>
                        <div class="invalid-feedback" id="montantError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="formModePaiement" class="form-label">{% trans "Mode de paiement" %}</label>
                        <select class="form-select" id="formModePaiement" name="mode_paiement" required>
                            <option value="">{% trans "Sélectionnez un mode de paiement" %}</option>
                            {% for mode in modes_paiement %}
                            <option value="{{ mode.id }}">{{ mode.libelle|escape }}</option>
                            {% empty %}
                            <option value="1">{% trans "Virement" %}</option>
                            <option value="2">{% trans "Chèque" %}</option>
                            <option value="3">{% trans "Espèces" %}</option>
                            <option value="4">{% trans "Carte bancaire" %}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="modePaiementError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="formTypeTransaction" class="form-label">{% trans "Type de transaction" %}</label>
                        <select class="form-select" id="formTypeTransaction" name="type_transaction">
                            <option value="paiement">{% trans "Paiement" %}</option>
                            <option value="remboursement">{% trans "Remboursement" %}</option>
                            <option value="rejet">{% trans "Rejet" %}</option>
                        </select>
                        <div class="invalid-feedback" id="typeTransactionError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="formDatePaiement" class="form-label">{% trans "Date de paiement" %}</label>
                        <input type="datetime-local" class="form-control" id="formDatePaiement" name="date_paiement" required>
                        <div class="invalid-feedback" id="datePaiementError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{% trans "Référence de paiement" %}</label>
                        <div class="form-control-plaintext bg-light p-2 rounded">
                            <i class="fas fa-info-circle text-info me-1" aria-hidden="true"></i>
                            {% trans "La référence du paiement sera créée automatiquement après l'enregistrement." %}
                        </div>
                        <input type="hidden" name="reference_paiement" value="">
                    </div>
                    
                    <div class="mb-3">
                        <label for="formCommentaire" class="form-label">{% trans "Commentaire" %}</label>
                        <textarea class="form-control" id="formCommentaire" name="commentaire" rows="2" maxlength="500"></textarea>
                        <div class="invalid-feedback" id="commentaireError"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Annuler" %}</button>
                <button type="button" class="btn btn-success" id="submitPaiement">
                    <i class="fas fa-save" aria-hidden="true"></i> {% trans "Enregistrer le paiement" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour l'ajout rapide de rappel -->
<div class="modal fade" id="rappelModal" tabindex="-1" aria-labelledby="rappelModalLabel" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rappelModalLabel">{% trans "Créer un rappel" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Fermer' %}"></button>
            </div>
            <div class="modal-body">
                <form id="rappelAjaxForm" data-cotisation-id="{{ cotisation.pk }}" novalidate>
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="formTypeRappel" class="form-label">{% trans "Type de rappel" %}</label>
                                <select class="form-select" id="formTypeRappel" name="type_rappel" required>
                                    <option value="">{% trans "Sélectionnez un type" %}</option>
                                    <option value="email" selected>{% trans "Email" %}</option>
                                    <option value="sms">{% trans "SMS" %}</option>
                                    <option value="courrier">{% trans "Courrier" %}</option>
                                    <option value="appel">{% trans "Appel téléphonique" %}</option>
                                </select>
                                <div class="invalid-feedback" id="typeRappelError"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="formNiveau" class="form-label">{% trans "Niveau de rappel" %}</label>
                                <input type="number" class="form-control" id="formNiveau" name="niveau" value="{% if rappels %}{{ rappels.count|add:'1' }}{% else %}1{% endif %}" min="1" max="5" required>
                                <div class="form-text">
                                    {% trans "1: Premier rappel, 2: Relance, 3: Mise en demeure, etc." %}
                                </div>
                                <div class="invalid-feedback" id="niveauError"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="formContenu" class="form-label">{% trans "Contenu du rappel" %}</label>
                        <div class="mb-2">
                            <div class="btn-group btn-group-sm" role="group" aria-label="{% trans 'Modèles de rappel' %}">
                                <button type="button" class="btn btn-outline-secondary" id="templateDefault">{% trans "Modèle standard" %}</button>
                                <button type="button" class="btn btn-outline-secondary" id="templateUrgent">{% trans "Modèle urgent" %}</button>
                                <button type="button" class="btn btn-outline-secondary" id="templateFormal">{% trans "Modèle formel" %}</button>
                            </div>
                        </div>
                        <textarea class="form-control" id="formContenu" name="contenu" rows="8" required maxlength="2000"></textarea>
                        <div class="form-text">
                            {% trans "Variables disponibles: {prenom}, {nom}, {reference}, {montant}, {date_echeance}, {date_limite}" %}
                        </div>
                        <div class="invalid-feedback" id="contenuError"></div>
                    </div>
                    
                    <!-- Options d'envoi -->
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6>{% trans "Options d'envoi" %}</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="envoyerImmediatement" name="envoyer_immediatement" checked>
                                <label class="form-check-label" for="envoyerImmediatement">
                                    {% trans "Envoyer immédiatement" %}
                                </label>
                            </div>
                            <div id="optionsPlanification" style="display: none;">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="datePlanification" class="form-label">{% trans "Date d'envoi" %}</label>
                                        <input type="date" class="form-control" id="datePlanification" name="date_planification" min="{{ now|date:'Y-m-d' }}">
                                        <div class="invalid-feedback" id="datePlanificationError"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="heurePlanification" class="form-label">{% trans "Heure d'envoi" %}</label>
                                        <input type="time" class="form-control" id="heurePlanification" name="heure_planification">
                                        <div class="invalid-feedback" id="heurePlanificationError"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Annuler" %}</button>
                <button type="button" class="btn btn-warning" id="submitRappel" aria-describedby="rappelModalLabel">
                    <i class="fas fa-bell" aria-hidden="true"></i> {% trans "Créer le rappel" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour afficher le contenu des rappels -->
<div class="modal fade" id="contenuModal" tabindex="-1" aria-labelledby="contenuModalLabel" aria-modal="true" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contenuModalLabel">{% trans "Contenu du rappel" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Fermer' %}"></button>
            </div>
            <div class="modal-body">
                <pre id="contenuRappel" class="p-3 bg-light rounded"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Fermer" %}</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour afficher les détails de l'historique -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-modal="true" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">{% trans "Détails de l'action" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Fermer' %}"></button>
            </div>
            <div class="modal-body">
                <div id="detailsHistorique" class="p-3 bg-light rounded">
                    <table class="table table-sm">
                        <tbody id="detailsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Fermer" %}</button>
            </div>
        </div>
    </div>
</div>

<!-- Message de confirmation -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="toastMessage" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
      <strong class="me-auto" id="toastTitle"></strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="{% trans 'Fermer' %}"></button>
    </div>
    <div class="toast-body" id="toastBody"></div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Styles pour l'animation des nouveaux éléments */
.new-item {
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.5s ease, transform 0.5s ease;
    background-color: rgba(40, 167, 69, 0.1);
}

.new-item.show {
    opacity: 1;
    transform: translateY(0);
}

/* Protection contre les attaques XSS dans les modals */
#contenuRappel, #detailsHistorique {
    overflow-x: auto;
    max-width: 100%;
    word-break: break-word;
}

/* Améliorations pour l'accessibilité */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.is-invalid {
    border-color: #dc3545;
}

.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.invalid-feedback.show {
    display: block;
}

/* Styles pour les boutons de template */
.btn-template {
    transition: all 0.3s ease;
}
.btn-template-active {
    background-color: #28a745 !important;
    color: white !important;
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}
.btn-template-inactive {
    background-color: #f8f9fa;
    color: #6c757d;
    border-color: #ced4da;
}

/* Amélioration focus pour accessibilité */
.modal:focus {
    outline: none;
}

.modal-content {
    border: 2px solid transparent;
}

.modal.show .modal-content {
    border-color: #007bff;
}
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
/**
 * Module de gestion des formulaires
 * Version sécurisée et optimisée pour l'application de cotisations
 */
const FormManager = (function() {
    /**
     * Réinitialise les erreurs d'un formulaire
     * @param {HTMLFormElement} form - Le formulaire à réinitialiser
     */
    function resetFormErrors(form) {
        if (!form) return;
        
        // Supprimer tous les messages d'erreur
        form.querySelectorAll('.invalid-feedback').forEach(el => {
            el.textContent = '';
            el.classList.remove('show');
        });
        
        // Réinitialiser l'état des champs
        form.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });
    }
    
    /**
     * Affiche les erreurs dans un formulaire
     * @param {HTMLFormElement} form - Le formulaire où afficher les erreurs
     * @param {Object} errors - Les erreurs à afficher (format: {champ: ["message d'erreur"]})
     */
    function displayFormErrors(form, errors) {
        // D'abord nettoyer les anciennes erreurs
        resetFormErrors(form);
        
        // Parcourir toutes les erreurs
        Object.keys(errors).forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (!field) return;
            
            // Marquer le champ comme invalide
            field.classList.add('is-invalid');
            
            // Récupérer le conteneur d'erreur dédié à ce champ
            const errorContainer = document.getElementById(`${fieldName}Error`);
            if (errorContainer) {
                errorContainer.textContent = Array.isArray(errors[fieldName]) 
                    ? errors[fieldName].join(' ') 
                    : errors[fieldName];
                errorContainer.classList.add('show');
            }
        });
    }
    
    /**
     * Sérialise un formulaire en objet JSON
     * @param {HTMLFormElement} form - Le formulaire à sérialiser
     * @returns {Object} - Les données du formulaire
     */
    function serializeForm(form) {
        const formData = new FormData(form);
        const data = {};
        
        formData.forEach((value, key) => {
            // Prévention XSS basique pour les champs texte
            if (typeof value === 'string') {
                value = value.trim();
            }
            data[key] = value;
        });
        
        return data;
    }
    
    /**
     * Initialise les gestionnaires d'événements pour les formulaires
     */
    function initFormHandlers() {
        // Réinitialiser les erreurs à l'ouverture des modales
        document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-bs-target');
                const modal = document.querySelector(targetId);
                if (modal) {
                    const form = modal.querySelector('form');
                    if (form) {
                        setTimeout(() => resetFormErrors(form), 100);
                    }
                }
            });
        });
        
        // Réinitialiser les erreurs lors de la saisie dans les champs
        document.addEventListener('input', function(e) {
            if (['INPUT', 'SELECT', 'TEXTAREA'].includes(e.target.tagName)) {
                const field = e.target;
                const fieldName = field.getAttribute('name');
                if (!fieldName) return;
                
                // Réinitialiser l'état du champ
                field.classList.remove('is-invalid');
                
                // Réinitialiser le message d'erreur
                const errorContainer = document.getElementById(`${fieldName}Error`);
                if (errorContainer) {
                    errorContainer.textContent = '';
                    errorContainer.classList.remove('show');
                }
            }
        });
    }
    
    // Interface publique du module
    return {
        resetFormErrors,
        displayFormErrors,
        serializeForm,
        initFormHandlers
    };
})();

/**
 * Module pour les notifications
 */
const NotificationManager = (function() {
    const toast = document.getElementById('toastMessage');
    let toastBootstrap;
    
    if (toast) {
        toastBootstrap = new bootstrap.Toast(toast);
    }
    
    /**
     * Affiche une notification toast
     * @param {string} message - Le message à afficher
     * @param {string} type - Le type de notification (success, error, warning, info)
     * @param {string} title - Le titre de la notification (optionnel)
     */
    function showToast(message, type = 'info', title = '') {
        if (!toast) return;
        
        // Définir le titre par défaut selon le type
        if (!title) {
            switch (type) {
                case 'success': title = "{% trans 'Succès' %}"; break;
                case 'error': title = "{% trans 'Erreur' %}"; break;
                case 'warning': title = "{% trans 'Attention' %}"; break;
                default: title = "{% trans 'Information' %}";
            }
        }
        
        // Définir les classes selon le type
        toast.className = 'toast';
        toast.classList.add(`text-bg-${type === 'error' ? 'danger' : type}`);
        
        // Mettre à jour le contenu
        document.getElementById('toastTitle').textContent = title;
        document.getElementById('toastBody').textContent = message;
        
        // Afficher la notification
        toastBootstrap.show();
    }
    
    return {
        showToast
    };
})();

/**
 * Module de gestion de l'accessibilité des modals
 */
const ModalAccessibilityManager = (function() {
    function init() {
        // Gestion du modal de paiement
        const paiementModal = document.getElementById('paiementModal');
        const paiementButton = document.querySelector('[data-bs-target="#paiementModal"]');
        
        if (paiementModal) {
            setupModalAccessibility(paiementModal, paiementButton);
        }
        
        // Gestion du modal de rappel
        const rappelModal = document.getElementById('rappelModal');
        const rappelButton = document.getElementById('rappelModalTrigger');
        
        if (rappelModal) {
            setupModalAccessibility(rappelModal, rappelButton);
        }
        
        // Gestion des autres modals
        const contenuModal = document.getElementById('contenuModal');
        const detailsModal = document.getElementById('detailsModal');
        
        if (contenuModal) {
            setupModalAccessibility(contenuModal);
        }
        
        if (detailsModal) {
            setupModalAccessibility(detailsModal);
        }
    }
    
    function setupModalAccessibility(modal, triggerButton) {
        if (!modal) return;
        
        // Événement à l'ouverture du modal
        modal.addEventListener('shown.bs.modal', function () {
            // Supprimer aria-hidden quand le modal est ouvert
            this.removeAttribute('aria-hidden');
            
            // Donner le focus au premier champ du formulaire ou au bouton de fermeture
            const firstInput = this.querySelector('input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled])');
            const closeButton = this.querySelector('.btn-close');
            
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            } else if (closeButton) {
                setTimeout(() => closeButton.focus(), 100);
            }
        });
        
        // Événement à la fermeture du modal
        modal.addEventListener('hidden.bs.modal', function () {
            // Remettre le focus sur le bouton qui a ouvert le modal
            if (triggerButton && document.contains(triggerButton)) {
                triggerButton.focus();
            }
        });
        
        // Événement avant la fermeture (pour éviter le conflit)
        modal.addEventListener('hide.bs.modal', function () {
            // Supprimer le focus des éléments internes avant la fermeture
            const focusedElement = this.querySelector(':focus');
            if (focusedElement && focusedElement !== this.querySelector('.btn-close')) {
                focusedElement.blur();
            }
        });
    }
    
    return {
        init
    };
})();

/**
 * Module de gestion des paiements
 */
const PaiementManager = (function() {
    /**
     * Initialise la gestion des paiements
     */
    function init() {
        const paiementForm = document.getElementById('paiementAjaxForm');
        const submitBtn = document.getElementById('submitPaiement');
        
        if (!paiementForm || !submitBtn) return;
        
        // Préremplir la date avec la date actuelle
        const dateInput = document.getElementById('formDatePaiement');
        if (dateInput) {
            const now = new Date();
            dateInput.value = now.toISOString().slice(0, 16);
        }
        
        // Définir la valeur numérique correcte pour le montant
        const montantInput = document.getElementById('formMontant');
        if (montantInput) {
            // Récupérer la valeur depuis l'attribut data et convertir en format numérique
            const montantRestantElement = document.getElementById('montant-restant');
            if (montantRestantElement) {
                const montantValue = montantRestantElement.dataset.value;
                // Convertir le format français (virgule) en format anglais (point) si nécessaire
                const montantNumeric = parseFloat(montantValue.toString().replace(',', '.'));
                if (!isNaN(montantNumeric)) {
                    montantInput.value = montantNumeric.toFixed(2);
                }
            }
        }
        
        // Gérer le type de transaction
        const typeSelect = document.getElementById('formTypeTransaction');
        
        if (typeSelect && montantInput) {
            typeSelect.addEventListener('change', function() {
                const montantRestant = parseFloat(document.getElementById('montant-restant').dataset.value || 0);
                const montantHelp = document.getElementById('montantHelp');
                
                if (this.value === 'paiement') {
                    // Pour un paiement, limiter au montant restant
                    montantInput.max = montantRestant;
                    montantHelp.innerHTML = `{% trans "Montant maximum autorisé" %}: <strong>${montantRestant.toFixed(2)} €</strong>`;
                    
                    // Ajuster automatiquement le montant s'il dépasse le montant restant
                    if (parseFloat(montantInput.value) > montantRestant) {
                        montantInput.value = montantRestant.toFixed(2);
                    }
                    
                    // Mettre en évidence cette limitation
                    montantHelp.classList.remove('text-muted');
                    montantHelp.classList.add('text-info');
                } else {
                    // Pour les autres types, pas de limite supérieure
                    montantInput.removeAttribute('max');
                    
                    // Adapter le message d'aide selon le type de transaction
                    if (this.value === 'remboursement') {
                        montantHelp.innerHTML = `{% trans "Remboursement - Aucune limite de montant" %}`;
                    } else if (this.value === 'rejet') {
                        montantHelp.innerHTML = `{% trans "Rejet de paiement - Aucune limite de montant" %}`;
                    }
                    
                    // Réinitialiser le style
                    montantHelp.classList.remove('text-info');
                    montantHelp.classList.add('text-muted');
                }
            });
            
            // Déclencher l'événement au chargement
            typeSelect.dispatchEvent(new Event('change'));
        }
        
        // Soumission du formulaire
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Désactiver le bouton pour éviter les clics multiples
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin" aria-hidden="true"></i> {% trans "Enregistrement..." %}';
            
            // Réinitialiser les erreurs
            FormManager.resetFormErrors(paiementForm);
            
            // Valider le formulaire côté client
            if (!validatePaiementForm(paiementForm)) {
                // Réactiver le bouton
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-save" aria-hidden="true"></i> {% trans "Enregistrer le paiement" %}';
                return;
            }
            
            // Récupérer les données du formulaire
            const formData = FormManager.serializeForm(paiementForm);
            
            // Préparer les données pour l'envoi
            const cotisationId = paiementForm.dataset.cotisationId;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Envoyer les données
            fetch(`/cotisations/${cotisationId}/paiement/ajax/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Afficher un message de succès
                    NotificationManager.showToast(data.message, 'success');
                    
                    // Mettre à jour l'interface
                    updateCotisationInfo(data.cotisation);
                    addPaiementToList(data.paiement);
                    
                    // Fermer la modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('paiementModal'));
                    if (modal) modal.hide();
                    
                    // Réinitialiser le formulaire
                    paiementForm.reset();
                } else {
                    // Afficher les erreurs
                    if (data.errors) {
                        try {
                            const errors = JSON.parse(data.errors);
                            FormManager.displayFormErrors(paiementForm, errors);
                        } catch (e) {
                            NotificationManager.showToast(data.message || "{% trans 'Une erreur est survenue lors du traitement de la requête' %}", 'error');
                        }
                    } else {
                        NotificationManager.showToast(data.message || "{% trans 'Une erreur est survenue lors du traitement de la requête' %}", 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                NotificationManager.showToast("{% trans 'Une erreur est survenue lors de la communication avec le serveur' %}", 'error');
            })
            .finally(() => {
                // Réactiver le bouton
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-save" aria-hidden="true"></i> {% trans "Enregistrer le paiement" %}';
            });
        });
    }
    
    /**
     * Valide le formulaire de paiement côté client
     * @param {HTMLFormElement} form - Le formulaire à valider
     * @returns {boolean} - True si le formulaire est valide, false sinon
     */
    function validatePaiementForm(form) {
        let isValid = true;
        const errors = {};
        
        // Vérifier le montant
        const montantInput = form.querySelector('[name="montant"]');
        if (montantInput) {
            const montant = parseFloat(montantInput.value);
            // Vérifier que le montant est valide
            if (isNaN(montant) || montant <= 0) {
                errors.montant = ["{% trans 'Le montant doit être supérieur à zéro' %}"];
                isValid = false;
            } else {
                // Vérifier que le montant ne dépasse pas le montant restant pour un paiement
                const typeTransaction = form.querySelector('[name="type_transaction"]').value;
                const montantRestant = parseFloat(document.getElementById('montant-restant').dataset.value || 0);
                
                if (typeTransaction === 'paiement' && montant > montantRestant) {
                    errors.montant = [`{% trans "Le montant ne peut pas dépasser le montant restant à payer" %} (${montantRestant.toFixed(2)} €)`];
                    isValid = false;
                    
                    // Mettre en évidence visuellement l'erreur
                    montantInput.classList.add('is-invalid');
                }
            }
        }
        
        // Vérifier le mode de paiement
        const modeSelect = form.querySelector('[name="mode_paiement"]');
        if (modeSelect && !modeSelect.value) {
            errors.mode_paiement = ["{% trans 'Veuillez sélectionner un mode de paiement' %}"];
            isValid = false;
        }
        
        // Vérifier la date
        const dateInput = form.querySelector('[name="date_paiement"]');
        if (dateInput && !dateInput.value) {
            errors.date_paiement = ["{% trans 'Veuillez saisir une date de paiement' %}"];
            isValid = false;
        }
        
        // Afficher les erreurs si nécessaire
        if (!isValid) {
            FormManager.displayFormErrors(form, errors);
        }
        
        return isValid;
    }
    
    /**
     * Met à jour les informations de la cotisation après un paiement
     * @param {Object} cotisationData - Les nouvelles données de la cotisation
     */
    function updateCotisationInfo(cotisationData) {
        if (!cotisationData) return;
        
        // Mettre à jour le montant restant
        const montantRestantElement = document.getElementById('montant-restant');
        if (montantRestantElement) {
            montantRestantElement.textContent = `${parseFloat(cotisationData.montant_restant).toFixed(2)} €`;
            montantRestantElement.dataset.value = cotisationData.montant_restant;
            
            // Mettre à jour la classe selon le montant restant
            montantRestantElement.className = 'fw-bold';
            if (parseFloat(cotisationData.montant_restant) > 0) {
                montantRestantElement.classList.add('text-danger');
            } else {
                montantRestantElement.classList.add('text-success');
            }
        }
        
        // Mettre à jour le montant payé
        const montantTotal = parseFloat(document.getElementById('montant-total').dataset.value || 0);
        const montantPaye = document.getElementById('montant-paye');
        if (montantPaye) {
            const payeValue = montantTotal - parseFloat(cotisationData.montant_restant);
            montantPaye.textContent = `${payeValue.toFixed(2)} €`;
            montantPaye.dataset.value = payeValue;
        }
        
        // Mettre à jour le statut de paiement
        const statutElement = document.getElementById('statut-paiement');
        if (statutElement) {
            statutElement.textContent = cotisationData.statut_paiement;
            statutElement.className = 'badge';
            statutElement.dataset.statut = cotisationData.statut_paiement.toLowerCase().replace(/\s+/g, '_');
            
            // Appliquer la classe appropriée
            if (cotisationData.statut_paiement.toLowerCase().includes('payée')) {
                statutElement.classList.add('bg-success');
            } else if (cotisationData.statut_paiement.toLowerCase().includes('partiellement')) {
                statutElement.classList.add('bg-warning');
            } else {
                statutElement.classList.add('bg-danger');
            }
        }
        
        // Mettre à jour la barre de progression
        const progressElement = document.getElementById('progression-paiement');
        if (progressElement) {
            const montantTotal = parseFloat(progressElement.dataset.montantTotal || 0);
            if (montantTotal > 0) {
                const pourcentage = Math.min(100, Math.max(0, ((montantTotal - parseFloat(cotisationData.montant_restant)) / montantTotal) * 100));
                progressElement.style.width = `${pourcentage.toFixed(1)}%`;
                progressElement.setAttribute('aria-valuenow', pourcentage.toFixed(1));
                progressElement.textContent = `${pourcentage.toFixed(1)}%`;
                
                // Mettre à jour la classe selon le pourcentage
                progressElement.className = 'progress-bar';
                if (pourcentage >= 100) {
                    progressElement.classList.add('bg-success');
                } else if (pourcentage > 0) {
                    progressElement.classList.add('bg-warning');
                } else {
                    progressElement.classList.add('bg-danger');
                }
            }
        }
    }
    
    /**
     * Ajoute un paiement à la liste des paiements
     * @param {Object} paiementData - Les données du paiement à ajouter
     */
    function addPaiementToList(paiementData) {
        if (!paiementData) return;
        
        const tableBody = document.querySelector('#paiements-list tbody');
        const noPaymentsMessage = document.getElementById('no-paiements-message');
        
        // Si la table n'existe pas encore, créer une nouvelle table
        if (!tableBody && noPaymentsMessage) {
            // Remplacer le message "Aucun paiement" par une table
            const container = noPaymentsMessage.parentNode;
            noPaymentsMessage.remove();
            
            // Créer la table
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="paiements-list">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Montant" %}</th>
                                <th>{% trans "Mode" %}</th>
                                <th>{% trans "Type" %}</th>
                                <th>{% trans "Référence" %}</th>
                                <th class="text-center">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        // Récupérer à nouveau le tbody qui pourrait avoir été créé
        const updatedTableBody = document.querySelector('#paiements-list tbody');
        if (!updatedTableBody) return;
        
        // Créer la ligne pour le nouveau paiement
        const row = document.createElement('tr');
        row.id = `paiement-${paiementData.id}`;
        row.className = 'new-item';
        
        // Formater la date
        const dateObj = new Date(paiementData.date_paiement);
        const formattedDate = dateObj.toLocaleString('fr-FR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Déterminer la classe pour le badge du type de transaction
        let typeBadgeClass = 'bg-secondary';
        if (paiementData.type_transaction.toLowerCase().includes('paiement')) {
            typeBadgeClass = 'bg-success';
        } else if (paiementData.type_transaction.toLowerCase().includes('remboursement')) {
            typeBadgeClass = 'bg-warning';
        } else if (paiementData.type_transaction.toLowerCase().includes('rejet')) {
            typeBadgeClass = 'bg-danger';
        }
        
        // Créer le contenu HTML de la ligne de manière sécurisée
        const cells = [
            `<td>${formattedDate}</td>`,
            `<td>${parseFloat(paiementData.montant).toFixed(2)} €</td>`,
            `<td>${paiementData.mode_paiement}</td>`,
            `<td><span class="badge ${typeBadgeClass}">${paiementData.type_transaction}</span></td>`,
            `<td>${paiementData.reference_paiement || '-'}</td>`,
            `<td class="text-center">
                <div class="btn-group">
                    <a href="/cotisations/paiements/${paiementData.id}/" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye" aria-hidden="true"></i>
                        <span class="visually-hidden">{% trans "Voir" %}</span>
                    </a>
                    <a href="/cotisations/paiements/${paiementData.id}/modifier/" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-edit" aria-hidden="true"></i>
                        <span class="visually-hidden">{% trans "Modifier" %}</span>
                    </a>
                    <a href="/cotisations/paiements/${paiementData.id}/supprimer/" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash" aria-hidden="true"></i>
                        <span class="visually-hidden">{% trans "Supprimer" %}</span>
                    </a>
                    ${paiementData.type_transaction.toLowerCase().includes('paiement') ? 
                    `<a href="/cotisations/api/generer-recu/${paiementData.id}/" class="btn btn-sm btn-outline-info" aria-label="{% trans 'Générer un reçu' %}">
                        <i class="fas fa-file-invoice" aria-hidden="true"></i>
                        <span class="visually-hidden">{% trans "Générer un reçu" %}</span>
                    </a>` : ''}
                </div>
            </td>`
        ];
        
        row.innerHTML = cells.join('');
        
        // Ajouter la ligne au début du tableau
        updatedTableBody.insertBefore(row, updatedTableBody.firstChild);
        
        // Animer l'apparition avec un délai pour permettre au DOM de se mettre à jour
        setTimeout(() => {
            row.classList.add('show');
        }, 50);
    }
    
    return {
        init
    };
})();

/**
 * Module de gestion des rappels
 */
const RappelManager = (function() {
    /**
     * Initialise la gestion des rappels
     */
    function init() {
        const rappelForm = document.getElementById('rappelAjaxForm');
        const submitBtn = document.getElementById('submitRappel');
        
        if (!rappelForm || !submitBtn) return;
        
        // Gérer l'affichage des options de planification
        const envoyerImmediatementSwitch = document.getElementById('envoyerImmediatement');
        const optionsPlanification = document.getElementById('optionsPlanification');
        
        if (envoyerImmediatementSwitch && optionsPlanification) {
            envoyerImmediatementSwitch.addEventListener('change', function() {
                optionsPlanification.style.display = this.checked ? 'none' : 'block';
                
                // Définir des valeurs par défaut lors du passage à planifié
                if (!this.checked) {
                    const datePlanification = document.getElementById('datePlanification');
                    const heurePlanification = document.getElementById('heurePlanification');
                    
                    if (datePlanification && !datePlanification.value) {
                        const demain = new Date();
                        demain.setDate(demain.getDate() + 1);
                        datePlanification.value = demain.toISOString().split('T')[0];
                    }
                    
                    if (heurePlanification && !heurePlanification.value) {
                        heurePlanification.value = '09:00';
                    }
                }
            });
        }
        
        // Initialiser les templates de rappel
        initRappelTemplates();
        
        // Mettre en surbrillance le bouton standard par défaut
        updateTemplateButtonStyles(document.getElementById('templateDefault'));

        // Soumission du formulaire
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Désactiver le bouton pour éviter les clics multiples
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin" aria-hidden="true"></i> {% trans "Création..." %}';
            
            // Réinitialiser les erreurs
            FormManager.resetFormErrors(rappelForm);
            
            // Valider le formulaire côté client
            if (!validateRappelForm(rappelForm)) {
                // Réactiver le bouton
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-bell" aria-hidden="true"></i> {% trans "Créer le rappel" %}';
                return;
            }
            
            // Récupérer les données du formulaire
            const formData = FormManager.serializeForm(rappelForm);
            
            // Gestion correcte de la planification
            const envoyerImmediatementChecked = envoyerImmediatementSwitch && envoyerImmediatementSwitch.checked;
            formData.planifie = envoyerImmediatementChecked ? 'false' : 'true';
            
            // Si planifié, combiner date et heure
            if (formData.planifie === 'true') {
                const datePlanification = document.getElementById('datePlanification');
                const heurePlanification = document.getElementById('heurePlanification');
                
                if (datePlanification && datePlanification.value) {
                    const heurePlanif = (heurePlanification && heurePlanification.value) ? heurePlanification.value : '09:00';
                    formData.date_planifiee = `${datePlanification.value}T${heurePlanif}`;
                }
            }
            
            // Préparer les données pour l'envoi
            const cotisationId = rappelForm.dataset.cotisationId;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Envoyer les données
            fetch(`/cotisations/${cotisationId}/rappel/ajax/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Afficher un message de succès
                    NotificationManager.showToast(data.message, 'success');
                    
                    // Ajouter le rappel à la liste
                    addRappelToList(data.rappel);
                    
                    // Fermer la modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('rappelModal'));
                    if (modal) modal.hide();
                    
                    // Réinitialiser le formulaire
                    rappelForm.reset();
                    
                    // Réinitialiser les options de planification
                    if (envoyerImmediatementSwitch) {
                        envoyerImmediatementSwitch.checked = true;
                        if (optionsPlanification) {
                            optionsPlanification.style.display = 'none';
                        }
                    }
                } else {
                    // Afficher les erreurs
                    if (data.errors) {
                        try {
                            const errors = JSON.parse(data.errors);
                            FormManager.displayFormErrors(rappelForm, errors);
                        } catch (e) {
                            NotificationManager.showToast(data.message || "{% trans 'Une erreur est survenue lors du traitement de la requête' %}", 'error');
                        }
                    } else {
                        NotificationManager.showToast(data.message || "{% trans 'Une erreur est survenue lors du traitement de la requête' %}", 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Erreur complète:', error);
                NotificationManager.showToast("{% trans 'Une erreur est survenue lors de la communication avec le serveur' %}: " + error.message, 'error');
            })
            .finally(() => {
                // Réactiver le bouton
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-bell" aria-hidden="true"></i> {% trans "Créer le rappel" %}';
            });
        });
    }

    // Fonction sécurisée pour les boutons de modèle
    function updateTemplateButtonStyles(activeButton) {
        if (!activeButton) return;
        
        const templateButtons = [
            document.getElementById('templateDefault'),
            document.getElementById('templateUrgent'),
            document.getElementById('templateFormal')
        ].filter(button => button !== null); // Filtrer les éléments null
        
        templateButtons.forEach(button => {
            if (!button) return;
            
            // Ajouter la classe de base pour tous les boutons
            button.classList.add('btn-template');
            
            // Appliquer la classe active/inactive selon le bouton cliqué
            if (button === activeButton) {
                button.classList.add('btn-template-active');
                button.classList.remove('btn-template-inactive', 'btn-outline-secondary');
            } else {
                button.classList.remove('btn-template-active', 'btn-outline-secondary');
                button.classList.add('btn-template-inactive');
            }
        });
    }
    
    /**
     * Initialise les templates de rappel
     */
    function initRappelTemplates() {
        const templateDefaultBtn = document.getElementById('templateDefault');
        const templateUrgentBtn = document.getElementById('templateUrgent');
        const templateFormalBtn = document.getElementById('templateFormal');
        const formContenu = document.getElementById('formContenu');
        
        if (!formContenu) return;
        
        // Template standard
        if (templateDefaultBtn) {
            templateDefaultBtn.addEventListener('click', function() {
                const prenom = document.getElementById('membre-prenom')?.textContent?.trim() || '{prenom}';
                const reference = document.getElementById('cotisation-reference')?.textContent?.trim() || '{reference}';
                const montant = document.getElementById('montant-restant')?.dataset?.value || '{montant}';
                const dateEcheance = document.querySelector('#cotisation-echeance')?.textContent?.trim().split('\n')[0] || '{date_echeance}';
                
                // Calculer la date limite (échéance + 7 jours)
                const dateLimite = new Date();
                dateLimite.setDate(dateLimite.getDate() + 7);
                const dateLimiteStr = dateLimite.toLocaleDateString('fr-FR');
                
                formContenu.value = `Cher/Chère ${prenom},

Nous vous rappelons que votre cotisation (réf. ${reference}) d'un montant restant dû de ${montant} € est arrivée à échéance le ${dateEcheance}.

Nous vous remercions de bien vouloir procéder au règlement avant le ${dateLimiteStr}.

Cordialement,
L'équipe de l'association`;

                updateTemplateButtonStyles(this);
            });
        }
        
        // Template urgent
        if (templateUrgentBtn) {
            templateUrgentBtn.addEventListener('click', function() {
                const prenom = document.getElementById('membre-prenom')?.textContent?.trim() || '{prenom}';
                const reference = document.getElementById('cotisation-reference')?.textContent?.trim() || '{reference}';
                const montant = document.getElementById('montant-restant')?.dataset?.value || '{montant}';
                const dateEcheance = document.querySelector('#cotisation-echeance')?.textContent?.trim().split('\n')[0] || '{date_echeance}';
                
                // Calculer la date limite (aujourd'hui + 5 jours)
                const dateLimite = new Date();
                dateLimite.setDate(dateLimite.getDate() + 5);
                const dateLimiteStr = dateLimite.toLocaleDateString('fr-FR');
                
                formContenu.value = `Cher/Chère ${prenom},

RAPPEL URGENT : Votre cotisation (réf. ${reference}) d'un montant de ${montant} € est en retard de paiement depuis le ${dateEcheance}.

Afin d'éviter toute procédure supplémentaire, nous vous invitons à régulariser cette situation avant le ${dateLimiteStr}.

Pour toute question ou difficulté, n'hésitez pas à nous contacter rapidement.

Cordialement,
L'équipe de l'association`;

                updateTemplateButtonStyles(this);
            });
        }
        
        // Template formel
        if (templateFormalBtn) {
            templateFormalBtn.addEventListener('click', function() {
                const nom = document.getElementById('membre-nom')?.textContent?.trim() || '{nom}';
                const prenom = document.getElementById('membre-prenom')?.textContent?.trim() || '{prenom}';
                const reference = document.getElementById('cotisation-reference')?.textContent?.trim() || '{reference}';
                const montant = document.getElementById('montant-restant')?.dataset?.value || '{montant}';
                const dateEcheance = document.querySelector('#cotisation-echeance')?.textContent?.trim().split('\n')[0] || '{date_echeance}';
                
                // Calculer la date limite (aujourd'hui + 10 jours)
                const dateLimite = new Date();
                dateLimite.setDate(dateLimite.getDate() + 10);
                const dateLimiteStr = dateLimite.toLocaleDateString('fr-FR');
                
                formContenu.value = `Madame, Monsieur ${nom},

Objet : Mise en demeure - Cotisation impayée

Nous constatons qu'à ce jour, malgré plusieurs rappels, votre cotisation référence ${reference} d'un montant de ${montant} € dont l'échéance était fixée au ${dateEcheance} n'a toujours pas été réglée.

Nous vous mettons donc en demeure de procéder au règlement intégral de cette somme avant le ${dateLimiteStr}.

À défaut de règlement dans ce délai, nous nous verrons contraints d'engager toutes les procédures nécessaires au recouvrement de cette créance, ce qui entraînera des frais supplémentaires à votre charge.

Veuillez agréer, Madame, Monsieur, l'expression de nos salutations distinguées.

La Direction`;

                updateTemplateButtonStyles(this);
            });
        }
    }
    
    /**
     * Valide le formulaire de rappel côté client
     * @param {HTMLFormElement} form - Le formulaire à valider
     * @returns {boolean} - True si le formulaire est valide, false sinon
     */
    function validateRappelForm(form) {
        let isValid = true;
        const errors = {};
        
        // Vérifier le type de rappel
        const typeSelect = form.querySelector('[name="type_rappel"]');
        if (typeSelect && !typeSelect.value) {
            errors.type_rappel = ["{% trans 'Veuillez sélectionner un type de rappel' %}"];
            isValid = false;
        }
        
        // Vérifier le niveau
        const niveauInput = form.querySelector('[name="niveau"]');
        if (niveauInput) {
            const niveau = parseInt(niveauInput.value);
            if (isNaN(niveau) || niveau < 1) {
                errors.niveau = ["{% trans 'Le niveau doit être un nombre entier positif' %}"];
                isValid = false;
            }
        }
        
        // Vérifier le contenu
        const contenuInput = form.querySelector('[name="contenu"]');
        if (contenuInput && !contenuInput.value.trim()) {
            errors.contenu = ["{% trans 'Veuillez saisir le contenu du rappel' %}"];
            isValid = false;
        }
        
        // Vérifier la planification si nécessaire
        const envoyerImmediatementSwitch = document.getElementById('envoyerImmediatement');
        if (envoyerImmediatementSwitch && !envoyerImmediatementSwitch.checked) {
            const datePlanification = document.getElementById('datePlanification');
            const heurePlanification = document.getElementById('heurePlanification');
            
            if (datePlanification && !datePlanification.value) {
                errors.date_planification = ["{% trans 'Veuillez saisir une date d\'envoi' %}"];
                isValid = false;
            }
            
            if (heurePlanification && !heurePlanification.value) {
                errors.heure_planification = ["{% trans 'Veuillez saisir une heure d\'envoi' %}"];
                isValid = false;
            }
            
            // Vérifier que la date/heure est dans le futur
            if (datePlanification && datePlanification.value && heurePlanification && heurePlanification.value) {
                const now = new Date();
                const planifiedDate = new Date(`${datePlanification.value}T${heurePlanification.value}`);
                
                if (planifiedDate <= now) {
                    errors.date_planification = ["{% trans 'La date et l\'heure d\'envoi doivent être dans le futur' %}"];
                    isValid = false;
                }
            }
        }
        
        // Afficher les erreurs si nécessaire
        if (!isValid) {
            FormManager.displayFormErrors(form, errors);
        }
        
        return isValid;
    }
    
    /**
     * Ajoute un rappel à la liste des rappels
     * @param {Object} rappelData - Les données du rappel à ajouter
     */
    function addRappelToList(rappelData) {
        if (!rappelData) return;
        
        const tableBody = document.querySelector('#rappels-list tbody');
        const noRappelsMessage = document.getElementById('no-rappels-message');
        
        // Si la table n'existe pas encore, créer une nouvelle table
        if (!tableBody && noRappelsMessage) {
            // Remplacer le message "Aucun rappel" par une table
            const container = noRappelsMessage.parentNode;
            noRappelsMessage.remove();
            
            // Créer la table
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="rappels-list">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Type" %}</th>
                                <th>{% trans "Niveau" %}</th>
                                <th>{% trans "État" %}</th>
                                <th>{% trans "Contenu" %}</th>
                                <th class="text-center">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        // Récupérer à nouveau le tbody qui pourrait avoir été créé
        const updatedTableBody = document.querySelector('#rappels-list tbody');
        if (!updatedTableBody) return;
        
        // Créer la ligne pour le nouveau rappel
        const row = document.createElement('tr');
        row.id = `rappel-${rappelData.id}`;
        row.className = 'new-item';
        
        // Formater la date
        const dateObj = new Date(rappelData.date_envoi);
        const formattedDate = dateObj.toLocaleString('fr-FR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Déterminer la classe pour le badge du niveau
        let niveauBadgeClass = 'bg-info';
        if (rappelData.niveau === 2) {
            niveauBadgeClass = 'bg-warning';
        } else if (rappelData.niveau >= 3) {
            niveauBadgeClass = 'bg-danger';
        }
        
        // Déterminer la classe pour le badge de l'état
        let etatBadgeClass = 'bg-secondary';
        if (rappelData.etat.toLowerCase().includes('envoye')) {
            etatBadgeClass = 'bg-success';
        } else if (rappelData.etat.toLowerCase().includes('echoue')) {
            etatBadgeClass = 'bg-danger';
        } else if (rappelData.etat.toLowerCase().includes('lu')) {
            etatBadgeClass = 'bg-info';
        }
        
        // Échapper le contenu pour éviter les attaques XSS
        const contenuSecurise = rappelData.contenu
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        
        // Créer le contenu HTML de la ligne de manière sécurisée
        const cells = [
            `<td>${formattedDate}</td>`,
            `<td>${rappelData.type_rappel}</td>`,
            `<td><span class="badge ${niveauBadgeClass}">${rappelData.niveau}</span></td>`,
            `<td><span class="badge ${etatBadgeClass}">${rappelData.etat}</span></td>`,
            `<td>
                <button type="button" class="btn btn-sm btn-link voir-contenu"
                        data-contenu="${contenuSecurise}"
                        data-bs-toggle="modal" data-bs-target="#contenuModal">
                    {% trans "Voir le contenu" %}
                </button>
            </td>`,
            `<td class="text-center">
                <div class="btn-group">
                    ${rappelData.etat.toLowerCase().includes('planifie') ? 
                    `<a href="/cotisations/rappels/${rappelData.id}/envoyer/" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-paper-plane" aria-hidden="true"></i> {% trans "Envoyer" %}
                    </a>` : ''}
                    <a href="/cotisations/rappels/${rappelData.id}/" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye" aria-hidden="true"></i>
                        <span class="visually-hidden">{% trans "Voir" %}</span>
                    </a>
                </div>
            </td>`
        ];
        
        row.innerHTML = cells.join('');
        
        // Ajouter la ligne au début du tableau
        updatedTableBody.insertBefore(row, updatedTableBody.firstChild);
        
        // Mettre à jour les gestionnaires d'événements pour le nouveau bouton "voir contenu"
        const voirContenuBtn = row.querySelector('.voir-contenu');
        if (voirContenuBtn) {
            voirContenuBtn.addEventListener('click', function() {
                const contenuRappel = document.getElementById('contenuRappel');
                if (contenuRappel) {
                    contenuRappel.textContent = this.getAttribute('data-contenu');
                }
            });
        }
        
        // Animer l'apparition avec un délai pour permettre au DOM de se mettre à jour
        setTimeout(() => {
            row.classList.add('show');
        }, 50);
    }
    
    return {
        init
    };
})();

/**
 * Module de gestion des modals et visualisations
 */
const UiManager = (function() {
    /**
     * Initialise les gestionnaires d'événements pour l'interface utilisateur
     */
    function init() {
        // Gestionnaire pour afficher le contenu des rappels
        document.querySelectorAll('.voir-contenu').forEach(btn => {
            btn.addEventListener('click', function() {
                const contenu = this.getAttribute('data-contenu');
                const contenuRappel = document.getElementById('contenuRappel');
                if (contenu && contenuRappel) {
                    contenuRappel.textContent = contenu;
                }
            });
        });
        
        // Gestionnaire pour afficher les détails de l'historique
        document.querySelectorAll('.voir-details').forEach(btn => {
            btn.addEventListener('click', function() {
                const detailsStr = this.getAttribute('data-details');
                try {
                    // Analyser le JSON de manière sécurisée
                    const details = JSON.parse(detailsStr);
                    displayHistoryDetails(details);
                } catch (e) {
                    console.error('Erreur lors du parsing des détails:', e);
                    const detailsTableBody = document.getElementById('detailsTableBody');
                    if (detailsTableBody) {
                        detailsTableBody.innerHTML = 
                            '<tr><td colspan="2">{% trans "Erreur lors du chargement des détails." %}</td></tr>';
                    }
                }
            });
        });
    }
    
    /**
     * Affiche les détails de l'historique dans la modal
     * @param {Object} details - Les détails à afficher
     */
    function displayHistoryDetails(details) {
        const detailsTableBody = document.getElementById('detailsTableBody');
        if (!detailsTableBody) return;
        
        // Vider le tableau
        detailsTableBody.innerHTML = '';
        
        // Fonction récursive pour afficher les détails
        function renderDetails(data, parentKey = '') {
            Object.entries(data).forEach(([key, value]) => {
                const row = document.createElement('tr');
                
                // Formater la clé
                const formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                const keyCell = document.createElement('th');
                keyCell.textContent = parentKey ? `${parentKey} - ${formattedKey}` : formattedKey;
                row.appendChild(keyCell);
                
                // Formater la valeur
                const valueCell = document.createElement('td');
                
                if (value !== null && typeof value === 'object') {
                    // Pour les objets imbriqués, créer un sous-tableau
                    const nestedTable = document.createElement('table');
                    nestedTable.className = 'table table-sm table-bordered mb-0';
                    
                    const nestedTbody = document.createElement('tbody');
                    nestedTable.appendChild(nestedTbody);
                    
                    Object.entries(value).forEach(([subKey, subValue]) => {
                        const subRow = document.createElement('tr');
                        
                        const subKeyCell = document.createElement('th');
                        subKeyCell.style.width = '40%';
                        subKeyCell.textContent = subKey.charAt(0).toUpperCase() + subKey.slice(1).replace(/_/g, ' ');
                        subRow.appendChild(subKeyCell);
                        
                        const subValueCell = document.createElement('td');
                        subValueCell.textContent = typeof subValue === 'object' && subValue !== null
                            ? JSON.stringify(subValue)
                            : subValue;
                        subRow.appendChild(subValueCell);
                        
                        nestedTbody.appendChild(subRow);
                    });
                    
                    valueCell.appendChild(nestedTable);
                } else {
                    // Pour les valeurs simples
                    valueCell.textContent = value;
                }
                
                row.appendChild(valueCell);
                detailsTableBody.appendChild(row);
            });
        }
        
        // Afficher les détails
        renderDetails(details);
    }
    
    return {
        init
    };
})();

// Initialisation à la fin du chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser la gestion des formulaires
    FormManager.initFormHandlers();
    
    // Initialiser la gestion de l'accessibilité des modals
    ModalAccessibilityManager.init();
    
    // Initialiser les gestionnaires UI
    UiManager.init();
    
    // Initialiser la gestion des paiements
    PaiementManager.init();
    
    // Initialiser la gestion des rappels
    RappelManager.init();
});
</script>
{% endblock %}