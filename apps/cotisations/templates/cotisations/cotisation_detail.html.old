{% extends "cotisations/base.html" %}
{% load i18n %}
{% load static %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'cotisations:cotisation_liste' %}">{% trans "Liste des cotisations" %}</a></li>
<li class="breadcrumb-item active">{{ cotisation.reference }}</li>
{% endblock %}

{% block page_title %}{% trans "Détail de la cotisation" %} <span class="text-muted">{{ cotisation.reference }}</span>{% endblock %}

{% block actions %}
<div class="btn-group">
    <a href="{% url 'cotisations:cotisation_modifier' pk=cotisation.pk %}" class="btn btn-outline-primary">
        <i class="fas fa-edit"></i> {% trans "Modifier" %}
    </a>
    <a href="{% url 'cotisations:paiement_creer' cotisation_id=cotisation.pk %}" class="btn btn-outline-success">
        <i class="fas fa-money-bill-wave"></i> {% trans "Ajouter un paiement" %}
    </a>
    <a href="{% url 'cotisations:rappel_creer' cotisation_id=cotisation.pk %}" class="btn btn-outline-warning">
        <i class="fas fa-bell"></i> {% trans "Créer un rappel" %}
    </a>
    <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
        <span class="visually-hidden">{% trans "Plus d'actions" %}</span>
    </button>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{% url 'cotisations:api_generer_recu' paiement_id=cotisation.paiements.first.id %}" target="_blank"><i class="fas fa-file-pdf me-2"></i> {% trans "Générer un reçu" %}</a></li>
        <li><a class="dropdown-item" href="{% url 'cotisations:cotisation_supprimer' pk=cotisation.pk %}"><i class="fas fa-trash me-2"></i> {% trans "Supprimer" %}</a></li>
    </ul>
</div>
{% endblock %}

{% block cotisations_content %}
<div class="row">
    <!-- Informations principales -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">{% trans "Informations générales" %}</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <th>{% trans "Référence" %}</th>
                            <td>{{ cotisation.reference }}</td>
                        </tr>
                        <tr>
                            <th>{% trans "Membre" %}</th>
                            <td>
                                <a href="{% url 'membres:membre_detail' pk=cotisation.membre.pk %}">
                                    {{ cotisation.membre.prenom }} {{ cotisation.membre.nom }}
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <th>{% trans "Type de membre" %}</th>
                            <td>{{ cotisation.type_membre.libelle }}</td>
                        </tr>
                        <tr>
                            <th>{% trans "Date d'émission" %}</th>
                            <td>{{ cotisation.date_emission|date:"d/m/Y" }}</td>
                        </tr>
                        <tr>
                            <th>{% trans "Date d'échéance" %}</th>
                            <td>
                                {% if cotisation.est_en_retard %}
                                <span class="text-danger">{{ cotisation.date_echeance|date:"d/m/Y" }}</span>
                                <br><small class="text-danger">{{ cotisation.jours_retard }} {% trans "jours de retard" %}</small>
                                {% else %}
                                {{ cotisation.date_echeance|date:"d/m/Y" }}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>{% trans "Période" %}</th>
                            <td>{{ cotisation.periode_debut|date:"d/m/Y" }} - {% if cotisation.periode_fin %}{{ cotisation.periode_fin|date:"d/m/Y" }}{% else %}{% trans "indéterminée" %}{% endif %}</td>
                        </tr>
                        <tr>
                            <th>{% trans "Barème" %}</th>
                            <td>{% if cotisation.bareme %}{{ cotisation.bareme }}{% else %}-{% endif %}</td>
                        </tr>
                        <tr>
                            <th>{% trans "Statut" %}</th>
                            <td>
                                {% if cotisation.statut_paiement == "non_payee" %}
                                <span class="badge bg-danger">{% trans "Non payée" %}</span>
                                {% elif cotisation.statut_paiement == "partiellement_payee" %}
                                <span class="badge bg-warning">{% trans "Partiellement payée" %}</span>
                                {% else %}
                                <span class="badge bg-success">{% trans "Payée" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Informations financières -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">{% trans "Informations financières" %}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col">
                        <div class="card bg-light">
                            <div class="card-body p-3 text-center">
                                <h6 class="card-subtitle mb-2 text-muted">{% trans "Montant total" %}</h6>
                                <h3 class="card-title text-primary mb-0">{{ cotisation.montant|floatformat:2 }} €</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card bg-light">
                            <div class="card-body p-3 text-center">
                                <h6 class="card-subtitle mb-2 text-muted">{% trans "Montant payé" %}</h6>
                                <h3 class="card-title text-success mb-0">{{ montant_paye|floatformat:2 }} €</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="card {% if cotisation.montant_restant > 0 %}bg-warning-subtle{% else %}bg-success-subtle{% endif %}">
                            <div class="card-body p-3 text-center">
                                <h6 class="card-subtitle mb-2 text-muted">{% trans "Reste à payer" %}</h6>
                                <h3 class="card-title {% if cotisation.montant_restant > 0 %}text-warning{% else %}text-success{% endif %} mb-0">
                                    {{ cotisation.montant_restant|floatformat:2 }} €
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if cotisation.commentaire %}
                <div class="mt-4">
                    <h6>{% trans "Commentaire" %}</h6>
                    <p class="card-text">{{ cotisation.commentaire }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Actions rapides -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">{% trans "Actions rapides" %}</h5>
            </div>
            <div class="card-body">
                {% if cotisation.statut_paiement != "payee" %}
                <h6>{% trans "Enregistrer un paiement" %}</h6>
                <form id="paiementRapideForm" action="{% url 'cotisations:paiement_create_ajax' cotisation_id=cotisation.pk %}" method="post" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_montant" class="form-label">{% trans "Montant" %}</label>
                        <div class="input-group">
                            <input type="number" step="0.01" min="0.01" max="{{ cotisation.montant_restant }}" name="montant" id="id_montant" class="form-control" value="{{ cotisation.montant_restant }}" required>
                            <span class="input-group-text">€</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="id_mode_paiement" class="form-label">{% trans "Mode de paiement" %}</label>
                        <select name="mode_paiement" id="id_mode_paiement" class="form-select" required>
                            <option value="">---</option>
                            {% for mode in paiement_form.fields.mode_paiement.queryset %}
                            <option value="{{ mode.id }}">{{ mode.libelle }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="id_reference_paiement" class="form-label">{% trans "Référence" %}</label>
                        <input type="text" name="reference_paiement" id="id_reference_paiement" class="form-control">
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-money-bill-wave me-2"></i> {% trans "Enregistrer le paiement" %}
                        </button>
                    </div>
                </form>
                
                <hr>
                
                <h6>{% trans "Créer un rappel" %}</h6>
                <form id="rappelRapideForm" action="{% url 'cotisations:rappel_create_ajax' cotisation_id=cotisation.pk %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_type_rappel" class="form-label">{% trans "Type de rappel" %}</label>
                        <select name="type_rappel" id="id_type_rappel" class="form-select" required>
                            <option value="email">{% trans "Email" %}</option>
                            <option value="sms">{% trans "SMS" %}</option>
                            <option value="courrier">{% trans "Courrier" %}</option>
                            <option value="appel">{% trans "Appel téléphonique" %}</option>
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-bell me-2"></i> {% trans "Créer un rappel" %}
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i> {% trans "Cette cotisation est entièrement payée." %}
                </div>
                <div class="d-grid gap-2 mt-4">
                    <a href="{% url 'cotisations:api_generer_recu' paiement_id=cotisation.paiements.first.id %}" class="btn btn-outline-primary" target="_blank">
                        <i class="fas fa-file-pdf me-2"></i> {% trans "Générer un reçu" %}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Liste des paiements -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">{% trans "Paiements" %}</h5>
                <span class="badge bg-primary">{{ paiements.count }}</span>
            </div>
            <div class="card-body">
                {% if paiements %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Montant" %}</th>
                                <th>{% trans "Mode" %}</th>
                                <th>{% trans "Référence" %}</th>
                                <th>{% trans "Type" %}</th>
                                <th>{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody id="paiements-list">
                            {% for paiement in paiements %}
                            <tr class="{% if paiement.type_transaction == 'remboursement' %}table-warning{% endif %}">
                                <td>{{ paiement.date_paiement|date:"d/m/Y H:i" }}</td>
                                <td>{{ paiement.montant|floatformat:2 }} €</td>
                                <td>{{ paiement.mode_paiement.libelle|default:"-" }}</td>
                                <td>{{ paiement.reference_paiement|default:"-" }}</td>
                                <td>
                                    {% if paiement.type_transaction == 'paiement' %}
                                    <span class="badge bg-success">{% trans "Paiement" %}</span>
                                    {% elif paiement.type_transaction == 'remboursement' %}
                                    <span class="badge bg-warning">{% trans "Remboursement" %}</span>
                                    {% elif paiement.type_transaction == 'rejet' %}
                                    <span class="badge bg-danger">{% trans "Rejet" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'cotisations:api_generer_recu' paiement_id=paiement.id %}" class="btn btn-outline-primary" title="{% trans 'Générer un reçu' %}" target="_blank">
                                            <i class="fas fa-file-pdf"></i>
                                        </a>
                                        <a href="{% url 'cotisations:paiement_modifier' pk=paiement.id %}" class="btn btn-outline-secondary" title="{% trans 'Modifier' %}">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'cotisations:paiement_supprimer' pk=paiement.id %}" class="btn btn-outline-danger" title="{% trans 'Supprimer' %}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i> {% trans "Aucun paiement enregistré pour cette cotisation." %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Liste des rappels -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">{% trans "Rappels" %}</h5>
                <span class="badge bg-primary">{{ rappels.count }}</span>
            </div>
            <div class="card-body">
                {% if rappels %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Type" %}</th>
                                <th>{% trans "Niveau" %}</th>
                                <th>{% trans "État" %}</th>
                                <th>{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody id="rappels-list">
                            {% for rappel in rappels %}
                            <tr>
                                <td>{{ rappel.date_envoi|date:"d/m/Y H:i" }}</td>
                                <td>{{ rappel.get_type_rappel_display }}</td>
                                <td>{{ rappel.niveau }}</td>
                                <td>
                                    {% if rappel.etat == 'planifie' %}
                                    <span class="badge bg-warning">{% trans "Planifié" %}</span>
                                    {% elif rappel.etat == 'envoye' %}
                                    <span class="badge bg-success">{% trans "Envoyé" %}</span>
                                    {% elif rappel.etat == 'echoue' %}
                                    <span class="badge bg-danger">{% trans "Échoué" %}</span>
                                    {% elif rappel.etat == 'lu' %}
                                    <span class="badge bg-info">{% trans "Lu" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if rappel.etat == 'planifie' %}
                                        <a href="{% url 'cotisations:envoyer_rappel' rappel_id=rappel.id %}" class="btn btn-outline-success" title="{% trans 'Envoyer maintenant' %}">
                                            <i class="fas fa-paper-plane"></i>
                                        </a>
                                        {% endif %}
                                        <button type="button" class="btn btn-outline-primary" title="{% trans 'Voir contenu' %}" data-bs-toggle="modal" data-bs-target="#rappelModal{{ rappel.id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Modal pour voir le contenu du rappel -->
                                    <div class="modal fade" id="rappelModal{{ rappel.id }}" tabindex="-1" aria-labelledby="rappelModalLabel{{ rappel.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="rappelModalLabel{{ rappel.id }}">{% trans "Contenu du rappel" %}</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p class="text-muted">{{ rappel.date_envoi|date:"d/m/Y H:i" }} - {{ rappel.get_type_rappel_display }} ({% trans "Niveau" %} {{ rappel.niveau }})</p>
                                                    <div class="card">
                                                        <div class="card-body">
                                                            {{ rappel.contenu|linebreaks }}
                                                        </div>
                                                    </div>
                                                    {% if rappel.resultat %}
                                                    <div class="mt-3">
                                                        <h6>{% trans "Résultat" %}</h6>
                                                        <p>{{ rappel.resultat }}</p>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Fermer" %}</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i> {% trans "Aucun rappel n'a été créé pour cette cotisation." %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Historique des modifications -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">{% trans "Historique" %}</h5>
                <span class="badge bg-primary">{{ historique.count }}</span>
            </div>
            <div class="card-body">
                {% if historique %}
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Action" %}</th>
                                <th>{% trans "Utilisateur" %}</th>
                                <th>{% trans "Détails" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for h in historique %}
                            <tr>
                                <td>{{ h.date_action|date:"d/m/Y H:i" }}</td>
                                <td>
                                    {% if h.action == 'creation' %}
                                    <span class="badge bg-success">{% trans "Création" %}</span>
                                    {% elif h.action == 'modification' %}
                                    <span class="badge bg-primary">{% trans "Modification" %}</span>
                                    {% elif h.action == 'suppression' %}
                                    <span class="badge bg-danger">{% trans "Suppression" %}</span>
                                    {% elif h.action == 'paiement_ajoute' %}
                                    <span class="badge bg-info">{% trans "Paiement ajouté" %}</span>
                                    {% elif h.action == 'paiement_supprime' %}
                                    <span class="badge bg-warning">{% trans "Paiement supprimé" %}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ h.action }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if h.utilisateur %}
                                    {{ h.utilisateur.username }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if h.details %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#historiqueModal{{ h.id }}">
                                        {% trans "Voir les détails" %}
                                    </button>
                                    
                                    <!-- Modal pour voir les détails -->
                                    <div class="modal fade" id="historiqueModal{{ h.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">{% trans "Détails" %} - {{ h.date_action|date:"d/m/Y H:i" }}</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <pre class="bg-light p-3 rounded"><code>{{ h.details|pprint }}</code></pre>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Fermer" %}</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i> {% trans "Aucun historique disponible pour cette cotisation." %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<!-- Mettre à jour les templates pour inclure ce fichier
 ajoutez cette ligne à la fin du bloc {% block extra_js %} -->

<script src="{% static 'js/cotisations/cotisations.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion du formulaire de paiement rapide
    const paiementForm = document.getElementById('paiementRapideForm');
    if (paiementForm) {
        paiementForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Afficher un message de succès
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    paiementForm.parentNode.insertBefore(alert, paiementForm);
                    
                    // Ajouter le paiement à la liste
                    const paiementsTable = document.getElementById('paiements-list');
                    if (paiementsTable) {
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td>${data.paiement.date_paiement}</td>
                            <td>${data.paiement.montant.toFixed(2)} €</td>
                            <td>${data.paiement.mode_paiement}</td>
                            <td>${data.paiement.reference_paiement || '-'}</td>
                            <td>
                                <span class="badge bg-success">{% trans "Paiement" %}</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'cotisations:api_generer_recu' paiement_id=0 %}".replace('0', data.paiement.id) class="btn btn-outline-primary" title="{% trans 'Générer un reçu' %}" target="_blank">
                                        <i class="fas fa-file-pdf"></i>
                                    </a>
                                    <a href="{% url 'cotisations:paiement_modifier' pk=0 %}".replace('0', data.paiement.id) class="btn btn-outline-secondary" title="{% trans 'Modifier' %}">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'cotisations:paiement_supprimer' pk=0 %}".replace('0', data.paiement.id) class="btn btn-outline-danger" title="{% trans 'Supprimer' %}">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        `;
                        paiementsTable.prepend(newRow);
                    }
                    
                    // Mettre à jour les informations de la cotisation
                    document.querySelectorAll('.montant-restant').forEach(el => {
                        el.textContent = data.cotisation.montant_restant.toFixed(2) + ' €';
                    });
                    
                    // Réinitialiser le formulaire
                    paiementForm.reset();
                    
                    // Recharger la page si la cotisation est complètement payée
                    if (data.cotisation.statut_paiement === "{% trans 'Payée' %}") {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                } else {
                    // Afficher un message d'erreur
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-danger alert-dismissible fade show';
                    alert.innerHTML = `
                        <i class="fas fa-exclamation-circle me-2"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    paiementForm.parentNode.insertBefore(alert, paiementForm);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        });
    }
    
    // Gestion du formulaire de rappel rapide (similaire au paiement)
    const rappelForm = document.getElementById('rappelRapideForm');
    if (rappelForm) {
        rappelForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Traitement similaire au paiement...
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    rappelForm.parentNode.insertBefore(alert, rappelForm);
                    
                    // Réinitialiser le formulaire
                    rappelForm.reset();
                    
                    // Recharger la page pour afficher le nouveau rappel
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    // Afficher un message d'erreur
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-danger alert-dismissible fade show';
                    alert.innerHTML = `
                        <i class="fas fa-exclamation-circle me-2"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    rappelForm.parentNode.insertBefore(alert, rappelForm);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        });
    }
});
</script>
{% endblock %}