<!-- Version 4 avec interface adaptative -->
{% extends "cotisations/base.html" %}
{% load i18n %}
{% load static %}
{% load cotisations_extras %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'cotisations:cotisation_liste' %}">{% trans "Liste des cotisations" %}</a></li>
<li class="breadcrumb-item active">{{ cotisation.reference|escape }}</li>
{% endblock %}

{% block page_title %}
{% trans "Détails de la cotisation" %} {{ cotisation.reference|escape }}
{% endblock %}

{% block actions %}
<div class="btn-group">
    <a href="{% url 'cotisations:cotisation_modifier' pk=cotisation.pk %}" class="btn btn-outline-secondary">
        <i class="fas fa-edit" aria-hidden="true"></i> {% trans "Modifier" %}
    </a>
    <a href="{% url 'cotisations:paiement_creer' cotisation_id=cotisation.pk %}" class="btn btn-success">
        <i class="fas fa-money-bill-wave" aria-hidden="true"></i> {% trans "Ajouter un paiement" %}
    </a>
    <a href="{% url 'cotisations:rappel_creer' cotisation_id=cotisation.pk %}" class="btn btn-warning">
        <i class="fas fa-bell" aria-hidden="true"></i> {% trans "Créer un rappel" %}
    </a>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#paiementModal">
        <i class="fas fa-plus-circle" aria-hidden="true"></i> {% trans "Paiement rapide" %}
    </button>
</div>
{% endblock %}

{% block cotisations_content %}
<div id="cotisationDetail" data-cotisation-id="{{ cotisation.pk }}">
    <div class="row">
        <!-- Informations principales de la cotisation -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">{% trans "Informations générales" %}</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">{% trans "Référence" %}</dt>
                        <dd class="col-sm-7" id="cotisation-reference">{{ cotisation.reference|escape }}</dd>
                        
                        <dt class="col-sm-5">{% trans "Membre" %}</dt>
                        <dd class="col-sm-7">
                            <a href="{% url 'membres:membre_detail' pk=cotisation.membre.pk %}">
                                <span id="membre-prenom">{{ cotisation.membre.prenom|escape }}</span> <span id="membre-nom">{{ cotisation.membre.nom|escape }}</span>
                            </a>
                            <br><small class="text-muted" id="membre-email">{{ cotisation.membre.email|escape }}</small>
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Date d'émission" %}</dt>
                        <dd class="col-sm-7">{{ cotisation.date_emission|date:"d/m/Y" }}</dd>
                        
                        <dt class="col-sm-5">{% trans "Date d'échéance" %}</dt>
                        <dd class="col-sm-7" id="cotisation-echeance">
                            <span class="{% if cotisation.est_en_retard %}text-danger{% endif %}">
                                {{ cotisation.date_echeance|date:"d/m/Y" }}
                                {% if cotisation.est_en_retard %}
                                <br><small class="text-danger">{{ cotisation.jours_retard }} {% trans "jours de retard" %}</small>
                                {% endif %}
                            </span>
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Période couverte" %}</dt>
                        <dd class="col-sm-7">
                            {{ cotisation.periode_debut|date:"d/m/Y" }}
                            {% if cotisation.periode_fin %}
                            - {{ cotisation.periode_fin|date:"d/m/Y" }}
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        
        <!-- Informations financières -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">{% trans "Informations financières" %}</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">{% trans "Type de membre" %}</dt>
                        <dd class="col-sm-7">{{ cotisation.type_membre.libelle|default:"-"|escape }}</dd>
                        
                        <dt class="col-sm-5">{% trans "Barème" %}</dt>
                        <dd class="col-sm-7">
                            {% if cotisation.bareme %}
                            {{ cotisation.bareme.montant|floatformat:2 }} € ({{ cotisation.bareme.get_periodicite_display }})
                            {% else %}
                            <span class="text-muted">{% trans "Non spécifié" %}</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Montant total" %}</dt>
                        <dd class="col-sm-7" id="montant-total" data-value="{{ cotisation.montant }}">{{ cotisation.montant|floatformat:2 }} €</dd>
                        
                        <dt class="col-sm-5">{% trans "Montant payé" %}</dt>
                        <dd class="col-sm-7">
                            <span id="montant-paye" data-value="{{ cotisation.montant|sub:cotisation.montant_restant }}">{{ cotisation.montant|sub:cotisation.montant_restant|floatformat:2 }} €</span>
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Montant restant" %}</dt>
                        <dd class="col-sm-7">
                            <span id="montant-restant" 
                                  class="fw-bold {% if cotisation.montant_restant > 0 %}text-danger{% else %}text-success{% endif %}"
                                  data-value="{{ cotisation.montant_restant }}">
                                {{ cotisation.montant_restant|floatformat:2 }} €
                            </span>
                        </dd>
                        
                        <dt class="col-sm-5">{% trans "Statut" %}</dt>
                        <dd class="col-sm-7">
                            <span id="statut-paiement" class="badge 
                                {% if cotisation.statut_paiement == 'non_payee' %}bg-danger
                                {% elif cotisation.statut_paiement == 'partiellement_payee' %}bg-warning
                                {% else %}bg-success{% endif %}"
                                data-statut="{{ cotisation.statut_paiement }}">
                                {{ cotisation.get_statut_paiement_display }}
                            </span>
                        </dd>
                    </dl>
                    
                    <!-- Barre de progression du paiement -->
                    <div class="mt-4">
                        <h6 class="mb-2">{% trans "Progression du paiement" %}</h6>
                        <div class="progress" style="height: 20px;">
                            {% with pourcentage=cotisation.pourcentage_paiement|default:0 %}
                            <div id="progression-paiement" class="progress-bar 
                                {% if cotisation.statut_paiement == 'non_payee' %}bg-danger
                                {% elif cotisation.statut_paiement == 'partiellement_payee' %}bg-warning
                                {% else %}bg-success{% endif %}" 
                                 role="progressbar" 
                                 data-montant-total="{{ cotisation.montant }}"
                                 style="width: {{ pourcentage }}%;" 
                                 aria-valuenow="{{ pourcentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ pourcentage }}%
                            </div>
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Liste des paiements -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="card-title mb-0">{% trans "Paiements" %}</h5>
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#paiementModal">
                        <i class="fas fa-plus" aria-hidden="true"></i> {% trans "Ajouter un paiement" %}
                    </button>
                </div>
                <div class="card-body">
                    {% if paiements %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="paiements-list">
                            <thead>
                                <tr>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Montant" %}</th>
                                    <th>{% trans "Mode" %}</th>
                                    <th>{% trans "Type" %}</th>
                                    <th>{% trans "Référence" %}</th>
                                    <th class="text-center">{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for paiement in paiements %}
                                <tr id="paiement-{{ paiement.id }}">
                                    <td>{{ paiement.date_paiement|date:"d/m/Y H:i" }}</td>
                                    <td>{{ paiement.montant|floatformat:2 }} €</td>
                                    <td>{{ paiement.mode_paiement|default:"-"|escape }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if paiement.type_transaction == 'paiement' %}bg-success
                                            {% elif paiement.type_transaction == 'remboursement' %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ paiement.get_type_transaction_display }}
                                        </span>
                                    </td>
                                    <td>{{ paiement.reference_paiement|default:"-"|escape }}</td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <a href="{% url 'cotisations:paiement_detail' pk=paiement.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye" aria-hidden="true"></i>
                                                <span class="visually-hidden">{% trans "Voir" %}</span>
                                            </a>
                                            <a href="{% url 'cotisations:paiement_modifier' pk=paiement.pk %}" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-edit" aria-hidden="true"></i>
                                                <span class="visually-hidden">{% trans "Modifier" %}</span>
                                            </a>
                                            <a href="{% url 'cotisations:paiement_supprimer' pk=paiement.pk %}" class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-trash" aria-hidden="true"></i>
                                                <span class="visually-hidden">{% trans "Supprimer" %}</span>
                                            </a>
                                            {% if paiement.type_transaction == 'paiement' %}
                                            <a href="{% url 'cotisations:api_generer_recu' paiement_id=paiement.pk %}" class="btn btn-sm btn-outline-info" aria-label="{% trans 'Générer un reçu' %}">
                                                <i class="fas fa-file-invoice" aria-hidden="true"></i>
                                                <span class="visually-hidden">{% trans "Générer un reçu" %}</span>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info" id="no-paiements-message">
                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        {% trans "Aucun paiement n'a été enregistré pour cette cotisation." %}
                        <button type="button" class="btn btn-sm btn-outline-primary ms-3" data-bs-toggle="modal" data-bs-target="#paiementModal">
                            {% trans "Ajouter un paiement" %}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Liste des rappels -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="card-title mb-0">{% trans "Rappels" %}</h5>
                    <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#rappelModal">
                        <i class="fas fa-plus" aria-hidden="true"></i> {% trans "Créer un rappel" %}
                    </button>
                </div>
                <div class="card-body">
                    {% if rappels %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="rappels-list">
                            <thead>
                                <tr>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Type" %}</th>
                                    <th>{% trans "Niveau" %}</th>
                                    <th>{% trans "État" %}</th>
                                    <th>{% trans "Contenu" %}</th>
                                    <th class="text-center">{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rappel in rappels %}
                                <tr id="rappel-{{ rappel.id }}">
                                    <td>{{ rappel.date_envoi|date:"d/m/Y H:i" }}</td>
                                    <td>{{ rappel.get_type_rappel_display }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if rappel.niveau == 1 %}bg-info
                                            {% elif rappel.niveau == 2 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ rappel.niveau }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if rappel.etat == 'planifie' %}bg-secondary
                                            {% elif rappel.etat == 'envoye' %}bg-success
                                            {% elif rappel.etat == 'echoue' %}bg-danger
                                            {% else %}bg-info{% endif %}">
                                            {{ rappel.get_etat_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-link voir-contenu"
                                                data-contenu="{{ rappel.contenu|escape }}"
                                                data-bs-toggle="modal" data-bs-target="#contenuModal">
                                            {% trans "Voir le contenu" %}
                                        </button>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            {% if rappel.etat == 'planifie' %}
                                            <a href="{% url 'cotisations:envoyer_rappel' rappel_id=rappel.pk %}" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-paper-plane" aria-hidden="true"></i> {% trans "Envoyer" %}
                                            </a>
                                            {% endif %}
                                            <a href="{% url 'cotisations:rappel_detail' pk=rappel.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye" aria-hidden="true"></i>
                                                <span class="visually-hidden">{% trans "Voir" %}</span>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info" id="no-rappels-message">
                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        {% trans "Aucun rappel n'a été créé pour cette cotisation." %}
                        <button type="button" class="btn btn-sm btn-outline-primary ms-3" data-bs-toggle="modal" data-bs-target="#rappelModal">
                            {% trans "Créer un rappel" %}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Historique des modifications -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">{% trans "Historique" %}</h5>
                </div>
                <div class="card-body">
                    {% if historique %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Action" %}</th>
                                    <th>{% trans "Utilisateur" %}</th>
                                    <th>{% trans "Détails" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in historique %}
                                <tr>
                                    <td>{{ entry.date_action|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if entry.action == 'creation' %}bg-success
                                            {% elif entry.action == 'modification' %}bg-info
                                            {% elif entry.action == 'suppression' %}bg-danger
                                            {% elif entry.action == 'paiement_ajoute' %}bg-primary
                                            {% elif entry.action == 'paiement_supprime' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ entry.get_action_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if entry.utilisateur %}
                                        {{ entry.utilisateur.username|escape }}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-link voir-details"
                                                data-details="{{ entry.details|escape }}"
                                                data-bs-toggle="modal" data-bs-target="#detailsModal">
                                            {% trans "Voir les détails" %}
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        {% trans "Aucun historique disponible pour cette cotisation." %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour l'ajout rapide de paiement -->
<div class="modal fade" id="paiementModal" tabindex="-1" aria-labelledby="paiementModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paiementModalLabel">{% trans "Ajouter un paiement" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="paiementAjaxForm" data-cotisation-id="{{ cotisation.pk }}" novalidate>
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="formMontant" class="form-label">{% trans "Montant" %}</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="formMontant" name="montant" value="{{ cotisation.montant_restant|floatformat:2 }}" min="0.01" step="0.01" required>
                            <span class="input-group-text">€</span>
                        </div>
                        <div id="montantHelp" class="form-text">
                            {% trans "Montant maximum autorisé" %}: {{ cotisation.montant_restant|floatformat:2 }} €
                        </div>
                        <div class="invalid-feedback" id="montantError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="formModePaiement" class="form-label">{% trans "Mode de paiement" %}</label>
                        <select class="form-select" id="formModePaiement" name="mode_paiement" required>
                            <option value="">{% trans "Sélectionnez un mode de paiement" %}</option>
                            {% for mode in modes_paiement %}
                            <option value="{{ mode.id }}">{{ mode.libelle|escape }}</option>
                            {% empty %}
                            <option value="1">{% trans "Virement" %}</option>
                            <option value="2">{% trans "Chèque" %}</option>
                            <option value="3">{% trans "Espèces" %}</option>
                            <option value="4">{% trans "Carte bancaire" %}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="modePaiementError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="formTypeTransaction" class="form-label">{% trans "Type de transaction" %}</label>
                        <select class="form-select" id="formTypeTransaction" name="type_transaction">
                            <option value="paiement">{% trans "Paiement" %}</option>
                            <option value="remboursement">{% trans "Remboursement" %}</option>
                            <option value="rejet">{% trans "Rejet" %}</option>
                        </select>
                        <div class="invalid-feedback" id="typeTransactionError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="formDatePaiement" class="form-label">{% trans "Date de paiement" %}</label>
                        <input type="datetime-local" class="form-control" id="formDatePaiement" name="date_paiement" required>
                        <div class="invalid-feedback" id="datePaiementError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">{% trans "Référence de paiement" %}</label>
                        <div class="form-control-plaintext bg-light p-2 rounded">
                            <i class="fas fa-info-circle text-info me-1" aria-hidden="true"></i>
                            {% trans "La référence du paiement sera créée automatiquement après l'enregistrement." %}
                        </div>
                        <input type="hidden" name="reference_paiement" value="">
                    </div>
                    
                    <div class="mb-3">
                        <label for="formCommentaire" class="form-label">{% trans "Commentaire" %}</label>
                        <textarea class="form-control" id="formCommentaire" name="commentaire" rows="2" maxlength="500"></textarea>
                        <div class="invalid-feedback" id="commentaireError"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Annuler" %}</button>
                <button type="button" class="btn btn-success" id="submitPaiement">
                    <i class="fas fa-save" aria-hidden="true"></i> {% trans "Enregistrer le paiement" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Rappel avec Interface Adaptative -->
<div class="modal fade" id="rappelModal" tabindex="-1" aria-labelledby="rappelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rappelModalLabel">
                    <i class="fas fa-paper-plane text-primary"></i>
                    Créer un rappel intelligent
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Marqueur pour l'interface adaptative -->
                <div data-constraints-ready="true" data-cotisation-id="{{ cotisation.id }}">
                    
                    <!-- Panneau des contraintes (sera déplacé par l'interface adaptative) -->
                    <div id="contraintes-panel" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Contraintes et recommandations</h6>
                            <div id="contraintes-content">Chargement des contraintes...</div>
                        </div>
                        <div id="validation-results" class="mt-3"></div>
                    </div>
                    
                    <!-- Formulaire existant (sera intégré dans l'interface adaptative) -->
                    <form id="rappelAjaxForm" data-cotisation-id="{{ cotisation.id }}" data-type="rappel">
                        {% csrf_token %}
                        <input type="hidden" name="cotisation_id" value="{{ cotisation.id }}">
                        
                        <!-- Champs cachés pour l'interface adaptative -->
                        <div style="display: none;">
                            <div class="form-group">
                                <label for="formTypeRappel">Type de rappel</label>
                                <select class="form-control" id="formTypeRappel" name="type_rappel" required>
                                    <option value="email">Email</option>
                                    <option value="sms">SMS</option>
                                    <option value="courrier">Courrier</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="formNiveau">Niveau d'urgence</label>
                                <input type="number" class="form-control" id="formNiveau" name="niveau" 
                                       min="1" max="5" value="1" required>
                            </div>
                        </div>
                        
                        <!-- Champs visibles (seront stylés par l'interface adaptative) -->
                        <div class="form-container-original">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group mb-3">
                                        <label for="formSujet" class="form-label">
                                            <span class="sujet-label">Sujet</span>
                                            <span class="sujet-constraint-info text-muted small"></span>
                                        </label>
                                        <input type="text" class="form-control" id="formSujet" name="sujet" 
                                               placeholder="Sujet du rappel">
                                        <div class="form-text sujet-help"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group mb-3">
                                        <label for="formContenu" class="form-label">
                                            Contenu du rappel
                                            <span class="contenu-stats text-muted small"></span>
                                        </label>
                                        <textarea class="form-control" id="formContenu" name="contenu" 
                                                  rows="8" placeholder="Contenu du rappel..." required></textarea>
                                        <div class="form-text contenu-help"></div>
                                        <div class="validation-feedback"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Templates par défaut (cachés, remplacés par l'interface adaptative) -->
                            <div id="templateDefault" style="display: none;">
                                <div class="btn-group mb-3" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-template" 
                                            data-template="standard">Standard</button>
                                    <button type="button" class="btn btn-outline-secondary btn-template" 
                                            data-template="urgent">Urgent</button>
                                    <button type="button" class="btn btn-outline-secondary btn-template" 
                                            data-template="formel">Formel</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div class="validation-summary">
                        <small class="text-muted" id="global-validation-status">
                            <i class="fas fa-check-circle text-success"></i>
                            Prêt à envoyer
                        </small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                        <button type="button" class="btn btn-primary" id="btnEnvoyerRappel">
                            <i class="fas fa-paper-plane"></i> Créer le rappel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour afficher le contenu des rappels -->
<div class="modal fade" id="contenuModal" tabindex="-1" aria-labelledby="contenuModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contenuModalLabel">{% trans "Contenu du rappel" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="contenuRappel" class="p-3 bg-light rounded"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Fermer" %}</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour afficher les détails de l'historique -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">{% trans "Détails de l'action" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="detailsHistorique" class="p-3 bg-light rounded">
                    <table class="table table-sm">
                        <tbody id="detailsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Fermer" %}</button>
            </div>
        </div>
    </div>
</div>

<!-- Message de confirmation -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="toastMessage" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
      <strong class="me-auto" id="toastTitle"></strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastBody"></div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- Styles pour l'interface adaptative -->
<link rel="stylesheet" href="{% static 'css/cotisations/interface-adaptative.css' %}">

<style>
/* Styles pour l'animation des nouveaux éléments */
.new-item {
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.5s ease, transform 0.5s ease;
    background-color: rgba(40, 167, 69, 0.1);
}

.new-item.show {
    opacity: 1;
    transform: translateY(0);
}

/* Protection contre les attaques XSS dans les modals */
#contenuRappel, #detailsHistorique {
    overflow-x: auto;
    max-width: 100%;
    word-break: break-word;
}

/* Améliorations pour l'accessibilité */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.is-invalid {
    border-color: #dc3545;
}

.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.invalid-feedback.show {
    display: block;
}

/* Ajouter ces styles dans la section CSS du fichier cotisation_detail.html */
.btn-template {
    transition: all 0.3s ease;
}
.btn-template-active {
    background-color: #28a745 !important;
    color: white !important;
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}
.btn-template-inactive {
    background-color: #f8f9fa;
    color: #6c757d;
    border-color: #ced4da;
}
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<!-- Scripts pour les contraintes intelligentes (déjà existants) -->
<script src="{% static 'js/cotisations/rappel-ajax.js' %}"></script>

<!-- NOUVEAU: Scripts pour l'interface adaptative -->
<script src="{% static 'js/cotisations/adaptive/interface-adaptive-manager.js' %}"></script>

<!-- Bibliothèques JS externes -->
<script src="{% static 'js/cotisations/form-validation.js' %}"></script>
<script>
/**
 * Module de gestion des formulaires
 * Version sécurisée et optimisée pour l'application de cotisations
 */
const FormManager = (function() {
    /**
     * Réinitialise les erreurs d'un formulaire
     * @param {HTMLFormElement} form - Le formulaire à réinitialiser
     */
    function resetFormErrors(form) {
        if (!form) return;
        
        // Supprimer tous les messages d'erreur
        form.querySelectorAll('.invalid-feedback').forEach(el => {
            el.textContent = '';
            el.classList.remove('show');
        });
        
        // Réinitialiser l'état des champs
        form.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });
    }
    
    /**
     * Affiche les erreurs dans un formulaire
     * @param {HTMLFormElement} form - Le formulaire où afficher les erreurs
     * @param {Object} errors - Les erreurs à afficher (format: {champ: ["message d'erreur"]})
     */
    function displayFormErrors(form, errors) {
        // D'abord nettoyer les anciennes erreurs
        resetFormErrors(form);
        
        // Parcourir toutes les erreurs
        Object.keys(errors).forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (!field) return;
            
            // Marquer le champ comme invalide
            field.classList.add('is-invalid');
            
            // Récupérer le conteneur d'erreur dédié à ce champ
            const errorContainer = document.getElementById(`${fieldName}Error`);
            if (errorContainer) {
                errorContainer.textContent = Array.isArray(errors[fieldName]) 
                    ? errors[fieldName].join(' ') 
                    : errors[fieldName];
                errorContainer.classList.add('show');
            }
        });
    }
    
    /**
     * Sérialise un formulaire en objet JSON
     * @param {HTMLFormElement} form - Le formulaire à sérialiser
     * @returns {Object} - Les données du formulaire
     */
    function serializeForm(form) {
        const formData = new FormData(form);
        const data = {};
        
        formData.forEach((value, key) => {
            // Prévention XSS basique pour les champs texte
            if (typeof value === 'string') {
                value = value.trim();
            }
            data[key] = value;
        });
        
        return data;
    }
    
    /**
     * Initialise les gestionnaires d'événements pour les formulaires
     */
    function initFormHandlers() {
        // Réinitialiser les erreurs à l'ouverture des modales
        document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-bs-target');
                const modal = document.querySelector(targetId);
                if (modal) {
                    const form = modal.querySelector('form');
                    if (form) {
                        setTimeout(() => resetFormErrors(form), 100);
                    }
                }
            });
        });
        
        // Réinitialiser les erreurs lors de la saisie dans les champs
        document.addEventListener('input', function(e) {
            if (['INPUT', 'SELECT', 'TEXTAREA'].includes(e.target.tagName)) {
                const field = e.target;
                const fieldName = field.getAttribute('name');
                if (!fieldName) return;
                
                // Réinitialiser l'état du champ
                field.classList.remove('is-invalid');
                
                // Réinitialiser le message d'erreur
                const errorContainer = document.getElementById(`${fieldName}Error`);
                if (errorContainer) {
                    errorContainer.textContent = '';
                    errorContainer.classList.remove('show');
                }
            }
        });
    }
    
    // Interface publique du module
    return {
        resetFormErrors,
        displayFormErrors,
        serializeForm,
        initFormHandlers
    };
})();

/**
 * Module pour les notifications
 */
const NotificationManager = (function() {
    const toast = document.getElementById('toastMessage');
    let toastBootstrap;
    
    if (toast) {
        toastBootstrap = new bootstrap.Toast(toast);
    }
    
    /**
     * Affiche une notification toast
     * @param {string} message - Le message à afficher
     * @param {string} type - Le type de notification (success, error, warning, info)
     * @param {string} title - Le titre de la notification (optionnel)
     */
    function showToast(message, type = 'info', title = '') {
        if (!toast) return;
        
        // Définir le titre par défaut selon le type
        if (!title) {
            switch (type) {
                case 'success': title = "{% trans 'Succès' %}"; break;
                case 'error': title = "{% trans 'Erreur' %}"; break;
                case 'warning': title = "{% trans 'Attention' %}"; break;
                default: title = "{% trans 'Information' %}";
            }
        }
        
        // Définir les classes selon le type
        toast.className = 'toast';
        toast.classList.add(`text-bg-${type === 'error' ? 'danger' : type}`);
        
        // Mettre à jour le contenu
        document.getElementById('toastTitle').textContent = title;
        document.getElementById('toastBody').textContent = message;
        
        // Afficher la notification
        toastBootstrap.show();
    }
    
    return {
        showToast
    };
})();

/**
 * Module de gestion des paiements
 */
const PaiementManager = (function() {
    /**
     * Initialise la gestion des paiements
     */
    function init() {
        const paiementForm = document.getElementById('paiementAjaxForm');
        const submitBtn = document.getElementById('submitPaiement');
        
        if (!paiementForm || !submitBtn) return;
        
        // Préremplir la date avec la date actuelle
        const dateInput = document.getElementById('formDatePaiement');
        if (dateInput) {
            const now = new Date();
            dateInput.value = now.toISOString().slice(0, 16);
        }
        
        // Gérer le type de transaction
        const typeSelect = document.getElementById('formTypeTransaction');
        const montantInput = document.getElementById('formMontant');
        
        if (typeSelect && montantInput) {
            typeSelect.addEventListener('change', function() {
                const montantRestant = parseFloat(document.getElementById('montant-restant').dataset.value || 0);
                const montantHelp = document.getElementById('montantHelp');
                
                if (this.value === 'paiement') {
                    // Pour un paiement, limiter au montant restant
                    montantInput.max = montantRestant;
                    montantHelp.innerHTML = `{% trans "Montant maximum autorisé" %}: <strong>${montantRestant.toFixed(2)} €</strong>`;
                    
                    // Ajuster automatiquement le montant s'il dépasse le montant restant
                    if (parseFloat(montantInput.value) > montantRestant) {
                        montantInput.value = montantRestant.toFixed(2);
                    }
                    
                    // Mettre en évidence cette limitation
                    montantHelp.classList.remove('text-muted');
                    montantHelp.classList.add('text-info');
                } else {
                    // Pour les autres types, pas de limite supérieure
                    montantInput.removeAttribute('max');
                    
                    // Adapter le message d'aide selon le type de transaction
                    if (this.value === 'remboursement') {
                        montantHelp.innerHTML = `{% trans "Remboursement - Aucune limite de montant" %}`;
                    } else if (this.value === 'rejet') {
                        montantHelp.innerHTML = `{% trans "Rejet de paiement - Aucune limite de montant" %}`;
                    }
                    
                    // Réinitialiser le style
                    montantHelp.classList.remove('text-info');
                    montantHelp.classList.add('text-muted');
                }
            });
            
            // Déclencher l'événement au chargement
            typeSelect.dispatchEvent(new Event('change'));
        }
        
        // Soumission du formulaire
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Réinitialiser les erreurs
            FormManager.resetFormErrors(paiementForm);
            
            // Valider le formulaire côté client
            if (!validatePaiementForm(paiementForm)) return;
            
            // Récupérer les données du formulaire
            const formData = FormManager.serializeForm(paiementForm);
            
            // Préparer les données pour l'envoi
            const cotisationId = paiementForm.dataset.cotisationId;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Envoyer les données
            fetch(`/cotisations/${cotisationId}/paiement/ajax/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Afficher un message de succès
                    NotificationManager.showToast(data.message, 'success');
                    
                    // Mettre à jour l'interface
                    updateCotisationInfo(data.cotisation);
                    addPaiementToList(data.paiement);
                    
                    // Fermer la modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('paiementModal'));
                    if (modal) modal.hide();
                    
                    // Réinitialiser le formulaire
                    paiementForm.reset();
                } else {
                    // Afficher les erreurs
                    if (data.errors) {
                        try {
                            const errors = JSON.parse(data.errors);
                            FormManager.displayFormErrors(paiementForm, errors);
                        } catch (e) {
                            NotificationManager.showToast(data.message || "{% trans 'Une erreur est survenue lors du traitement de la requête' %}", 'error');
                        }
                    } else {
                        NotificationManager.showToast(data.message || "{% trans 'Une erreur est survenue lors du traitement de la requête' %}", 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                NotificationManager.showToast("{% trans 'Une erreur est survenue lors de la communication avec le serveur' %}", 'error');
            });
        });
    }
    
    /**
     * Valide le formulaire de paiement côté client
     * @param {HTMLFormElement} form - Le formulaire à valider
     * @returns {boolean} - True si le formulaire est valide, false sinon
     */
    function validatePaiementForm(form) {
        let isValid = true;
        const errors = {};
        
        // Vérifier le montant
        const montantInput = form.querySelector('[name="montant"]');
        if (montantInput) {
            const montant = parseFloat(montantInput.value);
            // Vérifier que le montant est valide
            if (isNaN(montant) || montant <= 0) {
                errors.montant = ["{% trans 'Le montant doit être supérieur à zéro' %}"];
                isValid = false;
            } else {
                // Vérifier que le montant ne dépasse pas le montant restant pour un paiement
                const typeTransaction = form.querySelector('[name="type_transaction"]').value;
                const montantRestant = parseFloat(document.getElementById('montant-restant').dataset.value || 0);
                
                if (typeTransaction === 'paiement' && montant > montantRestant) {
                    errors.montant = [`{% trans "Le montant ne peut pas dépasser le montant restant à payer" %} (${montantRestant.toFixed(2)} €)`];
                    isValid = false;
                    
                    // Mettre en évidence visuellement l'erreur
                    montantInput.classList.add('is-invalid');
                }
            }
        }
        
        // Vérifier le mode de paiement
        const modeSelect = form.querySelector('[name="mode_paiement"]');
        if (modeSelect && !modeSelect.value) {
            errors.mode_paiement = ["{% trans 'Veuillez sélectionner un mode de paiement' %}"];
            isValid = false;
        }
        
        // Vérifier la date
        const dateInput = form.querySelector('[name="date_paiement"]');
        if (dateInput && !dateInput.value) {
            errors.date_paiement = ["{% trans 'Veuillez saisir une date de paiement' %}"];
            isValid = false;
        }
        
        // Afficher les erreurs si nécessaire
        if (!isValid) {
            FormManager.displayFormErrors(form, errors);
        }
        
        return isValid;
    }
    
    /**
     * Met à jour les informations de la cotisation après un paiement
     * @param {Object} cotisationData - Les nouvelles données de la cotisation
     */
    function updateCotisationInfo(cotisationData) {
        if (!cotisationData) return;
        
        // Mettre à jour le montant restant
        const montantRestantElement = document.getElementById('montant-restant');
        if (montantRestantElement) {
            montantRestantElement.textContent = `${parseFloat(cotisationData.montant_restant).toFixed(2)} €`;
            montantRestantElement.dataset.value = cotisationData.montant_restant;
            
            // Mettre à jour la classe selon le montant restant
            montantRestantElement.className = 'fw-bold';
            if (parseFloat(cotisationData.montant_restant) > 0) {
                montantRestantElement.classList.add('text-danger');
            } else {
                montantRestantElement.classList.add('text-success');
            }
        }
        
        // Mettre à jour le montant payé
        const montantTotal = parseFloat(document.getElementById('montant-total').dataset.value || 0);
        const montantPaye = document.getElementById('montant-paye');
        if (montantPaye) {
            const payeValue = montantTotal - parseFloat(cotisationData.montant_restant);
            montantPaye.textContent = `${payeValue.toFixed(2)} €`;
            montantPaye.dataset.value = payeValue;
        }
        
        // Mettre à jour le statut de paiement
        const statutElement = document.getElementById('statut-paiement');
        if (statutElement) {
            statutElement.textContent = cotisationData.statut_paiement;
            statutElement.className = 'badge';
            statutElement.dataset.statut = cotisationData.statut_paiement.toLowerCase().replace(/\s+/g, '_');
            
            // Appliquer la classe appropriée
            if (cotisationData.statut_paiement.toLowerCase().includes('payée')) {
                statutElement.classList.add('bg-success');
            } else if (cotisationData.statut_paiement.toLowerCase().includes('partiellement')) {
                statutElement.classList.add('bg-warning');
            } else {
                statutElement.classList.add('bg-danger');
            }
        }
        
        // Mettre à jour la barre de progression
        const progressElement = document.getElementById('progression-paiement');
        if (progressElement) {
            const montantTotal = parseFloat(progressElement.dataset.montantTotal || 0);
            if (montantTotal > 0) {
                const pourcentage = Math.min(100, Math.max(0, ((montantTotal - parseFloat(cotisationData.montant_restant)) / montantTotal) * 100));
                progressElement.style.width = `${pourcentage.toFixed(1)}%`;
                progressElement.setAttribute('aria-valuenow', pourcentage.toFixed(1));
                progressElement.textContent = `${pourcentage.toFixed(1)}%`;
                
                // Mettre à jour la classe selon le pourcentage
                progressElement.className = 'progress-bar';
                if (pourcentage >= 100) {
                    progressElement.classList.add('bg-success');
                } else if (pourcentage > 0) {
                    progressElement.classList.add('bg-warning');
                } else {
                    progressElement.classList.add('bg-danger');
                }
            }
        }
    }
    
    /**
     * Ajoute un paiement à la liste des paiements
     * @param {Object} paiementData - Les données du paiement à ajouter
     */
    function addPaiementToList(paiementData) {
        if (!paiementData) return;
        
        const tableBody = document.querySelector('#paiements-list tbody');
        const noPaymentsMessage = document.getElementById('no-paiements-message');
        
        // Si la table n'existe pas encore, créer une nouvelle table
        if (!tableBody && noPaymentsMessage) {
            // Remplacer le message "Aucun paiement" par une table
            const container = noPaymentsMessage.parentNode;
            noPaymentsMessage.remove();
            
            // Créer la table
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="paiements-list">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Montant" %}</th>
                                <th>{% trans "Mode" %}</th>
                                <th>{% trans "Type" %}</th>
                                <th>{% trans "Référence" %}</th>
                                <th class="text-center">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        // Récupérer à nouveau le tbody qui pourrait avoir été créé
        const updatedTableBody = document.querySelector('#paiements-list tbody');
        if (!updatedTableBody) return;
        
        // Créer la ligne pour le nouveau paiement
        const row = document.createElement('tr');
        row.id = `paiement-${paiementData.id}`;
        row.className = 'new-item';
        
        // Formater la date
        const dateObj = new Date(paiementData.date_paiement);
        const formattedDate = dateObj.toLocaleString('fr-FR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Déterminer la classe pour le badge du type de transaction
        let typeBadgeClass = 'bg-secondary';
        if (paiementData.type_transaction.toLowerCase().includes('paiement')) {
            typeBadgeClass = 'bg-success';
        } else if (paiementData.type_transaction.toLowerCase().includes('remboursement')) {
            typeBadgeClass = 'bg-warning';
        } else if (paiementData.type_transaction.toLowerCase().includes('rejet')) {
            typeBadgeClass = 'bg-danger';
        }
        
        // Créer le contenu HTML de la ligne de manière sécurisée
        const cells = [
            `<td>${formattedDate}</td>`,
            `<td>${parseFloat(paiementData.montant).toFixed(2)} €</td>`,
            `<td>${paiementData.mode_paiement}</td>`,
            `<td><span class="badge ${typeBadgeClass}">${paiementData.type_transaction}</span></td>`,
            `<td>${paiementData.reference_paiement || '-'}</td>`,
            `<td class="text-center">
                <div class="btn-group">
                    <a href="/cotisations/paiements/${paiementData.id}/" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye" aria-hidden="true"></i>
                        <span class="visually-hidden">{% trans "Voir" %}</span>
                    </a>
                    <a href="/cotisations/paiements/${paiementData.id}/modifier/" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-edit" aria-hidden="true"></i>
                        <span class="visually-hidden">{% trans "Modifier" %}</span>
                    </a>
                    <a href="/cotisations/paiements/${paiementData.id}/supprimer/" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash" aria-hidden="true"></i>
                        <span class="visually-hidden">{% trans "Supprimer" %}</span>
                    </a>
                    ${paiementData.type_transaction.toLowerCase().includes('paiement') ? 
                    `<a href="/cotisations/api/generer-recu/${paiementData.id}/" class="btn btn-sm btn-outline-info" aria-label="{% trans 'Générer un reçu' %}">
                        <i class="fas fa-file-invoice" aria-hidden="true"></i>
                        <span class="visually-hidden">{% trans "Générer un reçu" %}</span>
                    </a>` : ''}
                </div>
            </td>`
        ];
        
        row.innerHTML = cells.join('');
        
        // Ajouter la ligne au début du tableau
        updatedTableBody.insertBefore(row, updatedTableBody.firstChild);
        
        // Animer l'apparition avec un délai pour permettre au DOM de se mettre à jour
        setTimeout(() => {
            row.classList.add('show');
        }, 50);
    }
    
    return {
        init
    };
})();

// Script d'initialisation intégré
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initialisation de l\'interface adaptative pour cotisation {{ cotisation.id }}');
    
    // Configuration spécifique à cette cotisation
    window.cotisationConfig = {
        id: {{ cotisation.id }},
        membre: {
            nom: "{{ cotisation.membre.nom|escapejs }}",
            prenom: "{{ cotisation.membre.prenom|escapejs }}",
            email: "{{ cotisation.membre.email|escapejs }}"
        },
        montant_restant: {{ cotisation.montant_restant }},
        jours_retard: {{ cotisation.jours_retard|default:0 }},
        statut: "{{ cotisation.statut.nom|escapejs }}"
    };
    
    // Gestionnaire pour l'envoi du rappel avec validation
    document.getElementById('btnEnvoyerRappel').addEventListener('click', function() {
        const form = document.getElementById('rappelAjaxForm');
        const formData = new FormData(form);
        
        // Validation finale avant envoi
        if (typeof InterfaceAdaptativeManager !== 'undefined') {
            const state = InterfaceAdaptativeManager.getCurrentState();
            if (state.validationActive && !validateFinalForm()) {
                showValidationError('Veuillez corriger les erreurs avant d\'envoyer');
                return;
            }
        }
        
        // Afficher le spinner
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi en cours...';
        this.disabled = true;
        
        // Envoi AJAX
        fetch("{% url 'cotisations:api_creer_rappel' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fermer le modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('rappelModal'));
                modal.hide();
                
                // Afficher le succès
                showSuccessMessage('Rappel créé avec succès !');
                
                // Recharger la liste des rappels
                if (typeof loadRappelsList === 'function') {
                    loadRappelsList();
                }
            } else {
                showErrorMessage(data.message || 'Erreur lors de la création du rappel');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showErrorMessage('Erreur technique lors de l\'envoi');
        })
        .finally(() => {
            // Restaurer le bouton
            this.innerHTML = '<i class="fas fa-paper-plane"></i> Créer le rappel';
            this.disabled = false;
        });
    });
    
    // Fonctions utilitaires
    function validateFinalForm() {
        const typeRappel = document.getElementById('formTypeRappel').value;
        const contenu = document.getElementById('formContenu').value;
        const sujet = document.getElementById('formSujet').value;
        
        // Validation basique
        if (!contenu.trim()) {
            return false;
        }
        
        // Validation selon le type
        if (typeRappel === 'email' && !sujet.trim()) {
            return false;
        }
        
        if (typeRappel === 'sms' && contenu.length > 160) {
            return false;
        }
        
        return true;
    }
    
    function showValidationError(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.modal-body').prepend(alert);
    }
    
    function showSuccessMessage(message) {
        // Utiliser le système de messages existant
        const messagesContainer = document.querySelector('.messages') || 
                                document.querySelector('.alert-container') ||
                                document.body;
        
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-check-circle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        messagesContainer.appendChild(alert);
        
        // Auto-dismiss après 5 secondes
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
    
    function showErrorMessage(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.modal-body').prepend(alert);
    }
});

// Initialiser le gestionnaire de paiements
PaiementManager.init();
</script>
{% endblock %}