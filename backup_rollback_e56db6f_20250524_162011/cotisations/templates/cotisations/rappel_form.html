{% extends "cotisations/base.html" %}
{% load i18n %}
{% load static %}
{% load cotisations_extras %}

{% block breadcrumb %}
{% if form.instance.pk %}
<li class="breadcrumb-item"><a href="{% url 'cotisations:cotisation_liste' %}">{% trans "Liste des cotisations" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'cotisations:cotisation_detail' pk=cotisation.pk %}">{{ cotisation.reference }}</a></li>
<li class="breadcrumb-item active">{% trans "Modifier le rappel" %}</li>
{% else %}
<li class="breadcrumb-item"><a href="{% url 'cotisations:cotisation_liste' %}">{% trans "Liste des cotisations" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'cotisations:cotisation_detail' pk=cotisation.pk %}">{{ cotisation.reference }}</a></li>
<li class="breadcrumb-item active">{% trans "Cr√©er un rappel" %}</li>
{% endif %}
{% endblock %}

{% block page_title %}
{% if form.instance.pk %}
{% trans "Modifier le rappel" %}
{% else %}
{% trans "Cr√©er un rappel" %}
{% endif %}
{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/cotisations/interface-adaptative.css' %}">
{% endblock %}

{% block cotisations_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-paper-plane text-primary"></i>
                    Cr√©er un rappel intelligent
                </h2>
                <a href="{% url 'cotisations:cotisation_detail' cotisation.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Retour √† la cotisation
                </a>
            </div>
            
            <!-- Interface adaptative int√©gr√©e -->
            <div data-constraints-ready="true" data-cotisation-id="{{ cotisation.id }}">
                
                <!-- Panneau des contraintes -->
                <div id="contraintes-panel" class="card mb-4" style="display: none;">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-shield-alt text-info"></i>
                            Contraintes et recommandations
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="contraintes-content">Chargement des contraintes...</div>
                        <div id="validation-results" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- Formulaire principal -->
                <div class="card">
                    <div class="card-body">
                        <form id="rappelForm" method="post" data-cotisation-id="{{ cotisation.id }}" data-type="rappel">
                            {% csrf_token %}
                            <input type="hidden" name="cotisation_id" value="{{ cotisation.id }}">
                            
                            {% if form.errors %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                {% trans "Veuillez corriger les erreurs ci-dessous." %}
                            </div>
                            {% endif %}
                            
                            <!-- Champs cach√©s pour l'interface adaptative -->
                            <div style="display: none;">
                                <div class="form-group">
                                    <label for="{{ form.type_rappel.id_for_label }}">{{ form.type_rappel.label }}</label>
                                    {{ form.type_rappel }}
                                </div>
                                <div class="form-group">
                                    <label for="{{ form.niveau.id_for_label }}">{{ form.niveau.label }}</label>
                                    {{ form.niveau }}
                                </div>
                            </div>
                            
                            <!-- Champs visibles -->
                            <div class="form-container-original">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.sujet.id_for_label }}" class="form-label">
                                                <span class="sujet-label">{{ form.sujet.label }}</span>
                                                <span class="sujet-constraint-info text-muted small"></span>
                                            </label>
                                            {{ form.sujet }}
                                            <div class="form-text sujet-help"></div>
                                            {% if form.sujet.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.sujet.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.contenu.id_for_label }}" class="form-label">
                                                {{ form.contenu.label }}
                                                <span class="contenu-stats text-muted small"></span>
                                            </label>
                                            {{ form.contenu }}
                                            <div class="form-text contenu-help"></div>
                                            {% if form.contenu.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.contenu.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <div class="validation-summary">
                                        <small class="text-muted" id="global-validation-status">
                                            <i class="fas fa-check-circle text-success"></i>
                                            Formulaire valide
                                        </small>
                                    </div>
                                    <div>
                                        <a href="{% url 'cotisations:cotisation_detail' cotisation.id %}" 
                                           class="btn btn-secondary">
                                            <i class="fas fa-times"></i> Annuler
                                        </a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-paper-plane"></i> Cr√©er le rappel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Informations sur la cotisation (sidebar optionnelle) -->
<div class="row mt-4">
    {% if cotisation %}
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">{% trans "D√©tails de la cotisation" %}</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">{% trans "R√©f√©rence" %}</dt>
                    <dd class="col-sm-7">{{ cotisation.reference|escape }}</dd>
                    
                    <dt class="col-sm-5">{% trans "Membre" %}</dt>
                    <dd class="col-sm-7">
                        {{ cotisation.membre.prenom|escape }} {{ cotisation.membre.nom|escape }}
                        <br><small class="text-muted">{{ cotisation.membre.email|escape }}</small>
                    </dd>
                    
                    <dt class="col-sm-5">{% trans "Montant total" %}</dt>
                    <dd class="col-sm-7">{{ cotisation.montant|floatformat:2 }} ‚Ç¨</dd>
                    
                    <dt class="col-sm-5">{% trans "Montant restant" %}</dt>
                    <dd class="col-sm-7">
                        <span class="fw-bold {% if cotisation.montant_restant > 0 %}text-danger{% else %}text-success{% endif %}">
                            {{ cotisation.montant_restant|floatformat:2 }} ‚Ç¨
                        </span>
                    </dd>
                    
                    <dt class="col-sm-5">{% trans "Statut" %}</dt>
                    <dd class="col-sm-7">
                        {% if cotisation.statut_paiement == 'non_payee' %}
                        <span class="badge bg-danger">{% trans "Non pay√©e" %}</span>
                        {% elif cotisation.statut_paiement == 'partiellement_payee' %}
                        <span class="badge bg-warning">{% trans "Partiellement pay√©e" %}</span>
                        {% else %}
                        <span class="badge bg-success">{% trans "Pay√©e" %}</span>
                        {% endif %}
                    </dd>
                    
                    {% if cotisation.date_echeance %}
                    <dt class="col-sm-5">{% trans "√âch√©ance" %}</dt>
                    <dd class="col-sm-7">
                        <span class="{% if cotisation.est_en_retard %}text-danger{% endif %}">
                            {{ cotisation.date_echeance|date:"d/m/Y" }}
                            {% if cotisation.est_en_retard %}
                            <br><small class="text-danger">{{ cotisation.jours_retard }} {% trans "jours de retard" %}</small>
                            {% endif %}
                        </span>
                    </dd>
                    {% endif %}
                    
                    <!-- Dates cl√©s pour les rappels -->
                    <dt class="col-sm-5">{% trans "Dates de suivi" %}</dt>
                    <dd class="col-sm-7">
                        <small><strong>{% trans "Date limite rapide" %}:</strong> {{ today|add_days:7|date:"d/m/Y" }}</small><br>
                        <small><strong>{% trans "Date limite standard" %}:</strong> {{ today|add_days:15|date:"d/m/Y" }}</small><br>
                        <small><strong>{% trans "Date limite formelle" %}:</strong> {{ today|add_days:30|date:"d/m/Y" }}</small>
                    </dd>
                </dl>
                
                <!-- Liste des rappels pr√©c√©dents -->
                {% with rappels_precedents=cotisation.rappels.all %}
                {% if rappels_precedents %}
                <hr>
                <h6>{% trans "Rappels pr√©c√©dents" %}</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Type" %}</th>
                                <th>{% trans "Niveau" %}</th>
                                <th>{% trans "√âtat" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rappel in rappels_precedents|dictsortreversed:"date_envoi"|slice:":3" %}
                            <tr>
                                <td>{{ rappel.date_envoi|date:"d/m/Y" }}</td>
                                <td>{{ rappel.get_type_rappel_display }}</td>
                                <td>{{ rappel.niveau }}</td>
                                <td>
                                    {% if rappel.etat == 'planifie' %}
                                    <span class="badge bg-secondary">{% trans "Planifi√©" %}</span>
                                    {% elif rappel.etat == 'envoye' %}
                                    <span class="badge bg-success">{% trans "Envoy√©" %}</span>
                                    {% elif rappel.etat == 'echoue' %}
                                    <span class="badge bg-danger">{% trans "√âchou√©" %}</span>
                                    {% elif rappel.etat == 'lu' %}
                                    <span class="badge bg-info">{% trans "Lu" %}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if rappels_precedents.count > 3 %}
                <small class="text-muted">{% trans "Affichage des 3 derniers rappels sur" %} {{ rappels_precedents.count }}</small>
                {% endif %}
                {% endif %}
                {% endwith %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/cotisations/adaptive/interface-adaptive-manager.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation interface adaptative - Page d√©di√©e');
    
    // Configuration pour la page d√©di√©e
    window.cotisationConfig = {
        id: {{ cotisation.id }},
        membre: {
            nom: "{{ cotisation.membre.nom|escapejs }}",
            prenom: "{{ cotisation.membre.prenom|escapejs }}",
            email: "{{ cotisation.membre.email|escapejs }}"
        },
        montant_restant: {{ cotisation.montant_restant }},
        jours_retard: {{ cotisation.jours_retard|default:0 }},
        statut: "{{ cotisation.statut.nom|escapejs }}"
    };
    
    // Gestionnaire de soumission avec validation
    const form = document.getElementById('rappelForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Si l'interface adaptative est active, faire la validation
            if (typeof InterfaceAdaptativeManager !== 'undefined') {
                const state = InterfaceAdaptativeManager.getCurrentState();
                if (state.validationActive && !validateBeforeSubmit()) {
                    e.preventDefault();
                    showValidationErrors();
                    return false;
                }
            }
            
            // Permettre la soumission normale
            return true;
        });
    }
    
    function validateBeforeSubmit() {
        const typeRappel = document.getElementById('id_type_rappel').value;
        const contenu = document.getElementById('id_contenu').value;
        const sujet = document.getElementById('id_sujet').value;
        
        // Validation selon les contraintes
        if (typeRappel === 'email' && !sujet.trim()) {
            return false;
        }
        
        if (typeRappel === 'sms' && contenu.length > 160) {
            return false;
        }
        
        if (!contenu.trim()) {
            return false;
        }
        
        return true;
    }
    
    function showValidationErrors() {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            Veuillez corriger les erreurs de validation avant de continuer.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const form = document.getElementById('rappelForm');
        form.parentNode.insertBefore(alert, form);
        
        // Scroll vers l'erreur
        alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
});

/**
 * Module de gestion intelligente des rappels avec contraintes adaptatives
 * Version avec validation temps r√©el et interface adaptative
 */
const RappelIntelligentManager = (function() {
    // Configuration et cache
    let currentConfig = null;
    let currentConstraints = null;
    let validationTimer = null;
    let currentCotisationId = null;
    let suggestionsPanelVisible = false;
    
    // √âl√©ments DOM
    let elements = {};
    
    /**
     * Initialise le gestionnaire intelligent
     */
    function init() {
        console.log('üöÄ Initialisation du gestionnaire intelligent de rappels');
        
        // R√©cup√©rer les √©l√©ments DOM
        cacheElements();
        
        if (!elements.form) {
            console.error('‚ùå Formulaire de rappel non trouv√©');
            return;
        }
        
        // R√©cup√©rer l'ID de cotisation
        currentCotisationId = elements.form.dataset.cotisationId || getCurrentCotisationId();
        
        // Initialiser l'interface
        setupEventListeners();
        createIntelligentUI();
        
        // Charger la configuration initiale
        const initialType = elements.typeSelect ? elements.typeSelect.value : 'email';
        loadTypeConfiguration(initialType);
        
        console.log('‚úÖ Gestionnaire intelligent initialis√©');
    }
    
    /**
     * Cache les √©l√©ments DOM pour performance
     */
    function cacheElements() {
        elements = {
            form: document.getElementById('rappelAjaxForm') || document.getElementById('rappelForm'),
            typeSelect: document.getElementById('formTypeRappel') || document.getElementById('id_type_rappel'),
            niveauInput: document.getElementById('formNiveau') || document.getElementById('id_niveau'),
            contenuTextarea: document.getElementById('formContenu') || document.getElementById('id_contenu'),
            sujetInput: document.getElementById('formSujet') || document.getElementById('id_sujet'),
            submitBtn: document.getElementById('submitRappel') || document.querySelector('button[type="submit"]'),
            
            // √âl√©ments de planification
            envoyerImmediatement: document.getElementById('envoyerImmediatement'),
            datePlanification: document.getElementById('formDatePlanification') || document.getElementById('datePlanification'),
            heurePlanification: document.getElementById('formHeurePlanification') || document.getElementById('heurePlanification'),
            
            // Conteneurs pour l'interface intelligente
            formContainer: document.querySelector('.form-container') || elements.form?.parentElement,
            messagesContainer: document.querySelector('.messages') || elements.form?.querySelector('.alert')
        };
    }
    
    /**
     * Configure les gestionnaires d'√©v√©nements
     */
    function setupEventListeners() {
        // Changement de type de rappel
        if (elements.typeSelect) {
            elements.typeSelect.addEventListener('change', handleTypeChange);
        }
        
        // Changement de niveau
        if (elements.niveauInput) {
            elements.niveauInput.addEventListener('input', handleNiveauChange);
        }
        
        // Validation temps r√©el du contenu
        if (elements.contenuTextarea) {
            elements.contenuTextarea.addEventListener('input', debounce(handleContentChange, 500));
            elements.contenuTextarea.addEventListener('paste', () => {
                setTimeout(() => handleContentChange(), 100);
            });
        }
        
        // Validation du sujet
        if (elements.sujetInput) {
            elements.sujetInput.addEventListener('input', debounce(handleSubjectChange, 300));
        }
        
        // Gestion des dates/heures
        if (elements.datePlanification) {
            elements.datePlanification.addEventListener('change', handleDateTimeChange);
        }
        if (elements.heurePlanification) {
            elements.heurePlanification.addEventListener('change', handleDateTimeChange);
        }
        
        // Soumission du formulaire
        if (elements.submitBtn) {
            elements.submitBtn.addEventListener('click', handleFormSubmit);
        }
    }
    
    /**
     * Cr√©e l'interface utilisateur intelligente
     */
    function createIntelligentUI() {
        if (!elements.formContainer) return;
        
        // Cr√©er le panneau de contraintes
        createConstraintsPanel();
        
        // Cr√©er les indicateurs de validation
        createValidationIndicators();
        
        // Cr√©er le panneau de suggestions
        createSuggestionsPanel();
        
        // Cr√©er les compteurs de caract√®res
        createCharacterCounters();
        
        // Cr√©er les boutons d'optimisation
        createOptimizationButtons();
        
        console.log('üé® Interface intelligente cr√©√©e');
    }
    
    /**
     * Cr√©e le panneau d'affichage des contraintes
     */
    function createConstraintsPanel() {
        const constraintsPanel = document.createElement('div');
        constraintsPanel.id = 'constraints-panel';
        constraintsPanel.className = 'alert alert-info mt-3';
        constraintsPanel.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <span id="type-icon" class="fs-4">üìß</span>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong id="type-name">Email</strong>
                            <small class="text-muted d-block" id="type-description">Rappel par courrier √©lectronique</small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted" id="length-info">0 / 800 caract√®res</small>
                            <div class="progress mt-1" style="height: 4px; width: 120px;">
                                <div id="length-progress" class="progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="constraints-details" class="mt-2 small text-muted"></div>
        `;
        
        // Ins√©rer apr√®s le s√©lecteur de type
        if (elements.typeSelect) {
            elements.typeSelect.closest('.form-group, .mb-3')?.insertAdjacentElement('afterend', constraintsPanel);
        }
    }
    
    /**
     * Cr√©e les indicateurs de validation
     */
    function createValidationIndicators() {
        const indicators = document.createElement('div');
        indicators.id = 'validation-indicators';
        indicators.className = 'mt-2';
        indicators.innerHTML = `
            <div class="d-flex flex-wrap gap-2">
                <span id="sujet-indicator" class="badge bg-secondary">Sujet: Non v√©rifi√©</span>
                <span id="contenu-indicator" class="badge bg-secondary">Contenu: Non v√©rifi√©</span>
                <span id="longueur-indicator" class="badge bg-secondary">Longueur: Non v√©rifi√©</span>
                <span id="variables-indicator" class="badge bg-secondary">Variables: Non v√©rifi√©</span>
                <span id="horaire-indicator" class="badge bg-secondary">Horaire: Non v√©rifi√©</span>
            </div>
        `;
        
        // Ins√©rer apr√®s le panneau de contraintes
        const constraintsPanel = document.getElementById('constraints-panel');
        if (constraintsPanel) {
            constraintsPanel.insertAdjacentElement('afterend', indicators);
        }
    }
    
    /**
     * Cr√©e le panneau de suggestions
     */
    function createSuggestionsPanel() {
        const suggestionsPanel = document.createElement('div');
        suggestionsPanel.id = 'suggestions-panel';
        suggestionsPanel.className = 'card mt-3';
        suggestionsPanel.style.display = 'none';
        suggestionsPanel.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">üí° Suggestions d'am√©lioration</h6>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-suggestions">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            <div class="card-body" id="suggestions-content">
                <div class="text-muted text-center">
                    <i class="fas fa-lightbulb fa-2x mb-2"></i>
                    <p>Saisissez du contenu pour obtenir des suggestions personnalis√©es</p>
                </div>
            </div>
        `;
        
        // Ins√©rer avant le bouton de soumission
        if (elements.submitBtn) {
            elements.submitBtn.closest('.form-group, .mb-3')?.insertAdjacentElement('beforebegin', suggestionsPanel);
        }
        
        // Gestionnaire pour masquer/afficher
        const toggleBtn = suggestionsPanel.querySelector('#toggle-suggestions');
        toggleBtn.addEventListener('click', toggleSuggestionsPanel);
    }
    
    /**
     * Cr√©e les compteurs de caract√®res intelligents
     */
    function createCharacterCounters() {
        // Compteur pour le contenu
        if (elements.contenuTextarea) {
            const counter = document.createElement('div');
            counter.className = 'form-text d-flex justify-content-between align-items-center';
            counter.innerHTML = `
                <span id="content-counter">0 caract√®res</span>
                <span id="content-status" class="badge bg-secondary">En attente</span>
            `;
            elements.contenuTextarea.insertAdjacentElement('afterend', counter);
        }
        
        // Compteur pour le sujet
        if (elements.sujetInput) {
            const counter = document.createElement('div');
            counter.className = 'form-text';
            counter.innerHTML = `<span id="subject-counter">0 caract√®res</span>`;
            elements.sujetInput.insertAdjacentElement('afterend', counter);
        }
    }
    
    /**
     * Cr√©e les boutons d'optimisation
     */
    function createOptimizationButtons() {
        if (!elements.contenuTextarea) return;
        
        const optimizationRow = document.createElement('div');
        optimizationRow.className = 'btn-toolbar mt-2 justify-content-between';
        optimizationRow.innerHTML = `
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary" id="btn-optimize-auto">
                    <i class="fas fa-magic"></i> Optimiser
                </button>
                <button type="button" class="btn btn-outline-info" id="btn-preview-intelligent">
                    <i class="fas fa-eye"></i> Aper√ßu
                </button>
                <button type="button" class="btn btn-outline-success" id="btn-check-variables">
                    <i class="fas fa-check-circle"></i> Variables
                </button>
            </div>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-warning" id="btn-estimate-cost">
                    <i class="fas fa-calculator"></i> Co√ªt
                </button>
            </div>
        `;
        
        elements.contenuTextarea.insertAdjacentElement('afterend', optimizationRow);
        
        // Gestionnaires d'√©v√©nements
        document.getElementById('btn-optimize-auto')?.addEventListener('click', handleAutoOptimize);
        document.getElementById('btn-preview-intelligent')?.addEventListener('click', handleIntelligentPreview);
        document.getElementById('btn-check-variables')?.addEventListener('click', handleCheckVariables);
        document.getElementById('btn-estimate-cost')?.addEventListener('click', handleEstimateCost);
    }
    
    // ==================== GESTIONNAIRES D'√âV√âNEMENTS ====================
    
    async function handleTypeChange(event) {
        const newType = event.target.value;
        console.log(`üîÑ Changement de type: ${newType}`);
        
        await loadTypeConfiguration(newType);
        adaptInterfaceToType(newType);
        
        if (elements.contenuTextarea.value) {
            validateContentRealTime();
        }
    }
    
    async function loadTypeConfiguration(type) {
        try {
            const params = new URLSearchParams({
                type_rappel: type,
                jours_retard: getCurrentJoursRetard(),
                nb_destinataires: 1
            });
            
            const response = await fetch(`/cotisations/api/contraintes/?${params}`);
            const data = await response.json();
            
            if (data.success) {
                currentConfig = data;
                currentConstraints = data.contraintes;
                updateConstraintsDisplay();
                console.log(`‚úÖ Configuration charg√©e pour ${type}:`, data);
            } else {
                console.error('‚ùå Erreur chargement configuration:', data.message);
            }
        } catch (error) {
            console.error('‚ùå Erreur r√©seau:', error);
        }
    }
    
    function updateConstraintsDisplay() {
        if (!currentConstraints) return;
        
        const typeIcon = document.getElementById('type-icon');
        const typeName = document.getElementById('type-name');
        const typeDescription = document.getElementById('type-description');
        
        if (typeIcon) typeIcon.textContent = currentConstraints.icone;
        if (typeName) typeName.textContent = currentConstraints.nom;
        if (typeDescription) typeDescription.textContent = currentConstraints.description;
        
        const constraintsDetails = document.getElementById('constraints-details');
        if (constraintsDetails) {
            const details = [];
            details.push(`üìè Longueur: ${currentConstraints.longueur_min}-${currentConstraints.longueur_max} caract√®res`);
            details.push(`üéØ Optimal: ${currentConstraints.longueur_optimale} caract√®res`);
            
            if (currentConstraints.sujet_obligatoire) {
                details.push(`‚úÖ Sujet obligatoire`);
            }
            
            if (!currentConstraints.envoi_weekend) {
                details.push(`üö´ Pas d'envoi weekend`);
            }
            
            if (currentConstraints.heure_optimale) {
                details.push(`‚è∞ Heure optimale: ${currentConstraints.heure_optimale}`);
            }
            
            constraintsDetails.innerHTML = details.join(' ‚Ä¢ ');
        }
        
        const constraintsPanel = document.getElementById('constraints-panel');
        if (constraintsPanel && currentConstraints.couleur) {
            constraintsPanel.style.borderLeft = `4px solid ${currentConstraints.couleur}`;
        }
    }
    
    function adaptInterfaceToType(type) {
        if (elements.sujetInput) {
            const sujetGroup = elements.sujetInput.closest('.form-group, .mb-3');
            if (type === 'sms') {
                if (sujetGroup) sujetGroup.style.display = 'none';
                elements.sujetInput.value = '';
            } else {
                if (sujetGroup) sujetGroup.style.display = 'block';
                if (currentConstraints?.sujet_obligatoire) {
                    const label = sujetGroup.querySelector('label');
                    if (label && !label.textContent.includes('*')) {
                        label.innerHTML += ' <span class="text-danger">*</span>';
                    }
                }
            }
        }
    }
    
    async function validateContentRealTime() {
        if (!elements.contenuTextarea.value || !currentConfig) return;
        
        const requestData = {
            type_rappel: elements.typeSelect?.value || 'email',
            contenu: elements.contenuTextarea.value,
            sujet: elements.sujetInput?.value || '',
            nb_destinataires: 1
        };
        
        try {
            const response = await fetch('/cotisations/api/validation/contenu/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                updateValidationIndicators(data);
                updateCharacterCounters(data.statistiques);
                updateSuggestions(data.conseils);
            }
        } catch (error) {
            console.error('‚ùå Erreur validation temps r√©el:', error);
        }
    }
    
    function updateValidationIndicators(data) {
        const indicators = {
            'sujet-indicator': data.erreurs.some(e => e.champ === 'sujet') ? 
                { class: 'bg-danger', text: 'Sujet: Erreur' } : 
                { class: 'bg-success', text: 'Sujet: OK' },
            
            'contenu-indicator': data.erreurs.some(e => e.champ === 'contenu') ? 
                { class: 'bg-danger', text: 'Contenu: Erreur' } : 
                { class: 'bg-success', text: 'Contenu: OK' },
            
            'longueur-indicator': data.statistiques.dans_limites ? 
                { class: 'bg-success', text: 'Longueur: OK' } : 
                { class: 'bg-warning', text: 'Longueur: Attention' },
            
            'variables-indicator': data.statistiques.variables_ok !== false ? 
                { class: 'bg-success', text: 'Variables: OK' } : 
                { class: 'bg-warning', text: 'Variables: Attention' }
        };
        
        Object.entries(indicators).forEach(([id, info]) => {
            const element = document.getElementById(id);
            if (element) {
                element.className = `badge ${info.class}`;
                element.textContent = info.text;
            }
        });
    }
    
    function updateCharacterCounters(stats) {
        const contentCounter = document.getElementById('content-counter');
        const contentStatus = document.getElementById('content-status');
        
        if (contentCounter && stats) {
            const length = stats.longueur || 0;
            const maxLength = stats.longueur_max || 1000;
            const optimalLength = stats.longueur_optimale || 800;
            
            contentCounter.textContent = `${length} / ${maxLength} caract√®res`;
            
            if (stats.dans_limites) {
                const ratio = length / optimalLength;
                if (ratio >= 0.8 && ratio <= 1.2) {
                    contentStatus.className = 'badge bg-success';
                    contentStatus.textContent = 'Optimal';
                } else if (ratio < 0.8) {
                    contentStatus.className = 'badge bg-info';
                    contentStatus.textContent = 'Peut √™tre √©toff√©';
                } else {
                    contentStatus.className = 'badge bg-warning';
                    contentStatus.textContent = 'Un peu long';
                }
            } else {
                contentStatus.className = 'badge bg-danger';
                contentStatus.textContent = 'Hors limites';
            }
            
            const progressBar = document.getElementById('length-progress');
            if (progressBar) {
                const percentage = Math.min((length / maxLength) * 100, 100);
                progressBar.style.width = `${percentage}%`;
                
                if (percentage > 90) {
                    progressBar.className = 'progress-bar bg-danger';
                } else if (percentage > 75) {
                    progressBar.className = 'progress-bar bg-warning';
                } else {
                    progressBar.className = 'progress-bar bg-success';
                }
            }
            
            const lengthInfo = document.getElementById('length-info');
            if (lengthInfo) {
                lengthInfo.textContent = `${length} / ${optimalLength} caract√®res`;
            }
        }
        
        const subjectCounter = document.getElementById('subject-counter');
        if (subjectCounter && elements.sujetInput) {
            const subjectLength = elements.sujetInput.value.length;
            subjectCounter.textContent = `${subjectLength} caract√®res`;
            
            if (currentConstraints?.type_rappel === 'email' && subjectLength > 100) {
                subjectCounter.className = 'form-text text-warning';
            } else {
                subjectCounter.className = 'form-text text-muted';
            }
        }
    }
    
    function updateSuggestions(conseils) {
        const suggestionsContent = document.getElementById('suggestions-content');
        const suggestionsPanel = document.getElementById('suggestions-panel');
        
        if (!suggestionsContent || !suggestionsPanel) return;
        
        if (!conseils || conseils.length === 0) {
            suggestionsPanel.style.display = 'none';
            return;
        }
        
        suggestionsPanel.style.display = 'block';
        
        const suggestionsHTML = conseils.map(conseil => {
            const iconClass = conseil.type === 'error' ? 'fas fa-exclamation-triangle text-danger' :
                             conseil.type === 'warning' ? 'fas fa-exclamation-circle text-warning' :
                             'fas fa-lightbulb text-info';
            
            return `
                <div class="d-flex align-items-start mb-2">
                    <i class="${iconClass} me-2 mt-1"></i>
                    <div>
                        <small class="text-muted">${conseil.message}</small>
                    </div>
                </div>
            `;
        }).join('');
        
        suggestionsContent.innerHTML = suggestionsHTML;
    }
    
    // ==================== GESTIONNAIRES UTILITAIRES ====================
    
    function handleNiveauChange() {
        if (elements.typeSelect) {
            loadCompatibleTemplates(elements.typeSelect.value);
        }
    }
    
    function handleContentChange() {
        clearTimeout(validationTimer);
        validationTimer = setTimeout(validateContentRealTime, 500);
    }
    
    function handleSubjectChange() {
        validateContentRealTime();
    }
    
    function handleDateTimeChange() {
        validateContentRealTime();
    }
    
    async function handleAutoOptimize() {
        if (!elements.contenuTextarea.value) {
            alert('Aucun contenu √† optimiser');
            return;
        }
        
        const requestData = {
            type_rappel: elements.typeSelect?.value || 'email',
            contenu: elements.contenuTextarea.value,
            niveau: parseInt(elements.niveauInput?.value || 1)
        };
        
        try {
            const response = await fetch('/cotisations/api/optimisation/automatique/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.success && data.contenu_optimise !== data.contenu_original) {
                if (confirm('Contenu optimis√© g√©n√©r√©. Voulez-vous l\'appliquer ?')) {
                    elements.contenuTextarea.value = data.contenu_optimise;
                    validateContentRealTime();
                    alert('Contenu optimis√© avec succ√®s');
                }
            } else {
                alert('Le contenu est d√©j√† optimal');
            }
        } catch (error) {
            console.error('‚ùå Erreur optimisation:', error);
            alert('Erreur lors de l\'optimisation');
        }
    }
    
    async function handleIntelligentPreview() {
        const requestData = {
            type_rappel: elements.typeSelect?.value || 'email',
            contenu: elements.contenuTextarea.value,
            sujet: elements.sujetInput?.value || '',
            cotisation_id: currentCotisationId
        };
        
        try {
            const response = await fetch('/cotisations/api/previsualisation/intelligente/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Pr√©visualisation: ' + data.apercu);
            }
        } catch (error) {
            console.error('‚ùå Erreur pr√©visualisation:', error);
            alert('Erreur lors de la pr√©visualisation');
        }
    }
    
    function handleCheckVariables() {
        if (!currentConfig || !currentConfig.variables) return;
        
        let message = 'Variables disponibles:\n\n';
        message += 'üìã Variables communes:\n';
        message += '‚Ä¢ {prenom} - Pr√©nom du membre\n';
        message += '‚Ä¢ {nom} - Nom du membre\n';
        message += '‚Ä¢ {reference} - R√©f√©rence cotisation\n';
        message += '‚Ä¢ {montant} - Montant restant\n';
        message += '‚Ä¢ {date_echeance} - Date d\'√©ch√©ance\n';
        message += '‚Ä¢ {jours_retard} - Jours de retard\n';
        
        if (currentConfig.variables.speciales?.length > 0) {
            message += '\nüéØ Variables sp√©ciales pour ce type:\n';
            currentConfig.variables.speciales.forEach(v => {
                message += `‚Ä¢ {${v}}\n`;
            });
        }
        
        alert(message);
    }
    
    async function handleEstimateCost() {
        if (!currentConfig) return;
        
        const cost = currentConfig.cout_estime || 0;
        let message = `üí∞ Estimation de co√ªt:\n\n`;
        
        if (cost > 0) {
            message += `Co√ªt estim√©: ${cost.toFixed(2)} ‚Ç¨\n`;
            message += `Type: ${currentConfig.type_rappel}\n`;
            message += `Destinataires: 1`;
        } else {
            message += `Ce type de rappel est gratuit`;
        }
        
        alert(message);
    }
    
    async function handleFormSubmit(event) {
        event.preventDefault();
        
        console.log('üöÄ Soumission intelligente du formulaire');
        
        const isValid = await validateBeforeSubmit();
        
        if (!isValid) {
            alert('Veuillez corriger les erreurs avant d\'envoyer');
            return;
        }
        
        proceedWithSubmission();
    }
    
    async function validateBeforeSubmit() {
        const requestData = {
            type_rappel: elements.typeSelect?.value || 'email',
            contenu: elements.contenuTextarea.value,
            sujet: elements.sujetInput?.value || '',
            date_envoi: getPlannedDateTime(),
            nb_destinataires: 1
        };
        
        try {
            const response = await fetch('/cotisations/api/validation/contenu/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.success && data.valide) {
                return true;
            } else {
                data.erreurs?.forEach(erreur => {
                    alert(`${erreur.champ}: ${erreur.message}`);
                });
                return false;
            }
        } catch (error) {
            console.error('‚ùå Erreur validation finale:', error);
            return false;
        }
    }
    
    // ==================== FONCTIONS UTILITAIRES ====================
    
    function toggleSuggestionsPanel() {
        const panel = document.getElementById('suggestions-panel');
        const content = document.getElementById('suggestions-content');
        const icon = document.querySelector('#toggle-suggestions i');
        
        if (suggestionsPanelVisible) {
            content.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
            suggestionsPanelVisible = false;
        } else {
            content.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
            suggestionsPanelVisible = true;
        }
    }
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    function getCurrentCotisationId() {
        const urlParts = window.location.pathname.split('/');
        const cotisationIndex = urlParts.indexOf('cotisations');
        return cotisationIndex !== -1 ? urlParts[cotisationIndex + 1] : null;
    }
    
    function getCurrentJoursRetard() {
        return 0; // Placeholder
    }
    
    function getPlannedDateTime() {
        if (elements.envoyerImmediatement?.checked) {
            return null;
        }
        
        const date = elements.datePlanification?.value;
        const time = elements.heurePlanification?.value;
        
        return date && time ? `${date}T${time}:00` : null;
    }
    
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }
    
    function proceedWithSubmission() {
        console.log('‚úÖ Validation r√©ussie, soumission du formulaire');
        // Ici on peut appeler la fonction de soumission originale
    }
    
    return {
        init,
        validateContentRealTime,
        loadTypeConfiguration,
        handleTypeChange
    };
})();

// Auto-initialisation
RappelIntelligentManager.init();
</script>
{% endblock %}